# HTTP 协议
 
本文章部分内容引用自《白帽子讲浏览器安全》和其他网络博客。

## 一、概览

Http 协议是基于请求-响应的形式交互数据的无状态协议。客户端（浏览器）发送一个 Http 请求到服务器，然后服务器返回一个响应信息，响应的数据包含请求状态信息和具体内容。

## 二、版本
http 目前有 1.0、1.1、2.0、3.0 四个版本。

### 1 http 1.0 （tcp）

1.0 版本的 http 协议是非持久的，每一次的请求都需要重新建立 TCP 连接（三次握手），支持 GET、POST、HEAD 三种请求方法。

### 2 http 1.1 (tcp)

1. 支持长连接，默认不关闭，可以被每个请求复用
2. 提供了管道机制，允许多个请求同时发送，增加并发性
3. HTTP 1.1 请求头新增了 host 字段，用来处理服务器存在多个虚拟主机的情况
4. 提供身份认证机制，设置特殊的状态码和头部进行身份认证

### 3 http 2.0 (tcp)

1. 支持全双工请求
2. 支持服务端推送
3. 支持利用二进制帧传递报头和数据
4. 增加头部信息压缩机制（gzip、compress)
5. 增加头部信息索引表

### 4 http 3.0 (quic-udp)

QUIC (Quick UDP Internet Connections)是基于UDP的传输层协议，提供像 TCP 一样的可靠性。

1. 优化了线头阻塞问题
2. 自定义链接：在 quic 层中维护连接机制，端口变化，id不变，就不需要重新建立连接
3. 自定义重传
4. 无阻塞多路服用
5. 自定义流量控制

## 三、http 连接建立的过程

### 1 基于 TCP 的三次握手：

1. 客户端返送 [SYN] 标记的包，Seq 初始序列号为 x,发送完成后客户端进入，SYNC_SEND 状态
2. 服务器返回 [SYN, ACK] 服务端进入 SYN_SEND 状态
3. 客户端返回 [ACK]，进入 ESTABLISHED 状态，服务端接收到数据包后也进入 ESTABLISHED 状态。

### 2 基于 TCP 的四次挥手：

1. 客户端发送 [FIN]，进入 CLOSE_WAIT_1 状态
2. 服务端发送 [ACK]，进入 CLOSE_WAIT_1 状态
3. 服务端发送 [FIN]，进入 LAST_ACK 状态
4. 客户端发送 [ACK]，进入 TIME_WAIT 状态，服务端接收到数据包，关闭连接进入 CLOSE 状态。客户端等待固定时间后，未收到 ACK 包，便关闭连接。

### 3 http 3.0 是基于 QUIC (UDP) 实现的，所以没有繁琐地创建连接的过程。

## 四、http 的状态码

### 1 信息响应

1. 100 这个临时响应表明，迄今为止的所有内容都是可行的，客户端应该继续请求，如果已经完成则忽略
2. 101 该代码是响应客户端的 Upgrade (en-US) 请求头发送的，指明服务器即将切换的协议
3. 102 此代码表示服务器已经收到并且正在处理的请求，但当前没有响应可用
4. 103 主要和 Link 链接头一起使用，允许用户代理在服务器准备响应阶段开始预加载资源

### 2 响应成功

1. 200 请求成功
2. 201 请求成功并且创建了一个新资源（通常在 POST PUT 请求之后返回的响应）
3. 202 请求已经被接收到，但还未响应，没有结果。意味着不会有一个异步的相应去表明当前请求的结果，预期另外的进程和服务去处理请求，或批处理。
4. 203 服务器已经成功处理了请求，但返回的实体头部的元数据不是在原始服务器上有效的确定集合，二是来自本地或者第三方的拷贝。当前的信息可能是原始版本的子集或者超级。
5. 204 没有内容可发送，但头部字段可能会有用。用户代理可能会用此时请求头部信息来更新原来资源的头部缓存字段
6. 205 告诉用户代理重置发送此请求的文档
7. 206 当从客户端发送 range 范围标头以之请求资源的一部分时，将使用此响应代码
8. 207 对于多个状态代码都可能合适的情况，传输有关多个资源的信息。
9. 226 服务器已经完成了对资源 GET 的请求，并且响应是对当前实例应用的一个或多个实例操作结果的表示

### 3 重定向消息

1. 300 拥有多个可能的响应，用户代理或者用户应当从中选择一个
2. 301 请求的资源已经永久更改。在响应中给出了新的 URL
3. 302 此响应代码表示所有请求资源的 URI 已经暂时更改。未来可能会对 URI 进行进一步的改变
4. 303 服务器发送此响应，以指示客户端通过一个 GET 请求在另一个 URI 中获取请求的资源
5. 304 用于缓存的目的，告诉客户端响应还没有被修改，因此客户端可以继续使用相同的缓存版本的响应
6. 305 请求的响应必须被代理访问
7. 306 此响应代码不再被使用
8. 307 服务器发送此响应，以指示客户端使用在前一个请求中使用的相同方法在另一个 URI 上获取请求的资源。这与 302  Found HTTP 响应代码有相同语义，用户代理不能更改所使用的 HTTP 方法。如果在第一个请求中使用 POST 则在第二个请求中必须使用 POST
9. 308 这意味着资源现在永久位于由 Location: HTTP Response 标头指定的另一个 URI。这与 301 Moved Permanently HTTP 响应代码具有相同的意义，但用户代理不能更改 HTTP Method

### 4 客户端错误响应

1. 400 客户端错误，服务器无法或不会处理请求
2. 401 虽然 HTTP 标准制定了 unauthorized 但从语义上来说，这个响应意味着 "unauthenticated"。也就是说，客户端必须对自身进行身份验证才能获得请求的响应
3. 402 此响应代码保留将来使用。创建此代码的最初目的是将其用于数字支付系统。但此状态代码很少使用，并且不存在标准约定
4. 403 客户端没有访问内容的权限；它是未经授权的，因此服务器拒绝提供资源。与 401 不同，服务器知道客户端的身份。
5. 404 服务器找不到请求的资源。在浏览器中，这意味着无法识别 URL
6. 405 服务器知道请求方法，但目标资源不支持该方法。
7. 406 当 web 服务器在执行服务端驱动型内容协商机制后，没有发现任何符合用户代理给定标准的内容时，就会发送此响应
8. 407 类似 401 Unauthorized 但是认证需要由代理完成
9. 408 此响应由一些服务器在空闲连接上发送，即使客户端之前没有任何请求。这意味着服务器像关闭这个未使用的连接。
10. 409 当请求与服务器当前的状态冲突时，将发送此响应
11. 410 当请求内容的内容已从服务器中永久删除且没有转发地址时，将发送此响应

### 5 服务端错误响应

1. 500 服务器遇到了不知道如何处理的情况
2. 501 Not Implemented 服务器不支持请求方法，因此无法处理。服务器必须支持 GET 和 HEAD 方法
3. 502 网关错误
4. 503 服务器没有准备好处理请求。常见原因是服务器因维护或重而停机
5. 504 网关超时
6. 505 服务器不支持请求中使用的 HTTP 版本
7. 506 服务器存在内部配置错误
8. 507 无法在资源上执行该方法
9. 508 服务器在处理请求时检测到无限循环
10. 509 服务器需要对请求做进一步扩展才能完成需求
11. 511 客户端需要进行身份验证才能获得网络访问权限

