# NodeJS 到底是什么？
- （Node.js 弊端）参考 CSDN 耳双月月鸟儿 -《Node.js的特点及应用场景》
- libuv 阶段和实现、NodeJS 启动流程参考 灰信网 - NODEJS 如何利用 LIBUV 实现事件循环和异步
## 利用 JavaScript 和操作系统交互
JavaScript 语言是一门解释型的脚本语言，最初只内嵌在浏览器端改变页面样式。NodeJS 是基于 v8 的 JavaScript 解释器（运行环境），使 JavaScript 可以脱离浏览器环境运行，真正成为门一个计算机语言。

通过 NodeJS, 我们可以用 JavaScript 和计算机上的操作系统进行交互，调用操作系统的功能，进行：数据计算；处理输入设备的输入（例如键盘鼠标，话筒）；控制输出设备进行输出（例如在显示器上展示我们想要的内容，利用打印机打印文件）等。

它和 c 、c++、 Java、Python 这些语言一样，都被翻译成二进制代码，在计算机的内存中存储并得到执行。但是他们的设计目的不大相同，不同的语言有各自不同的特点，例如 c 语言被设计成为可以方便直接地操作存储空间，所以在嵌入式、操作系统等应用方面大放异彩。

NodeJS 扩展了前端程序员的边界，使精通 JavaScript 程序设计的人才可以做更多的事情。
## 语言特点
NodeJS 的事件驱动，实现了非阻塞 I/O 模型，使得异步操作轻量又高效。
### 事件循环
v8 本身不实现事件循环机制，由宿主环境实现，NodeJS 的事件循环大致表现与浏览器一致，都是 循环+任务队列的模式。在 NodeJS 中，新增了任务类型和任务阶段。如文件 I/O, setImmediate, process.nextTick 等。
#### 实现（libuv)
NodeJS 是基于 libuv 库实现的，libuv 是一个跨平台的基于事件驱动的异步 ui 库，它提供进程、线程、信号、定时器、进程间通信等功能。
##### libuv 简介
libuv 利用操作系统提供的事件驱动模块解决网络异步IO，利用线程池解决维诺健IO。

nodejs 利用 libuv  注册时间和回调。
##### libuv 事件循环模式
libuv 的事件循环有以下几种模式：
- UV_RUN_DEFAULT：运行事件循环直到结束所有事件和请求。
- UV_RUN_ONCE：对 IO 轮询，如果没有需要执行的回调函数，会被阻塞，返回0完成，返回非0未完成，不继续运行事件循环。。
- UV_RUN_NOWAIT：对 IO 轮询，如果没有待处理的回调，不会阻塞。
##### libuv 事件循环各个阶段
libuv 事件循环的各个阶段是：
- 定时器
- pending callback
- idle callback
- prepare callback
- poll i/o (网络文件 i/o)
- check(setImmediate)
- callback 的关闭

每个阶段都有各自的执行队列。当一个队列内的事件全部执行完成后，执行下一阶段的事件。
##### libuv 依赖的数据结构
- 最小堆（定时器）
- 链表（check、idle）
- 线程池（文件 io）
- 操作系统提供的事件驱动模块（网络io）
#### 启动流程
- 注册内置 c++ 模块
- 新建 process 的 c++ 对象，初始化对象，挂载到全局
- 执行 bootstrap_node.js，初始化 nextTick，setTimeout 等，加载用户 js，解释执行
- 调用 livuv 开启事件循环
（剩下的在原理章节详细介绍）
## 优缺点
### 优点
io 密集型场景、高并发的性能较好。
### 缺点
- 无法利用多核 CPU
- 错误会引起整个应用的退出
- 计算密集型的场景性能差
#### 缓解方案
- 利用 pm2, forever 可以实现创建多进程解决多核 CPU 的利用率问题。
- 利用 child_process, cluster 等。
- 负载均衡，开多个端口。
- 进程监控，错误自动重启。

## 应用场景
在应用需要处理大量并发 I/O, 程序内部不需要进行非常复杂的处理时，NodeJS 性能很好。

### 高并发 web 应用程序
### 多人联网游戏
### 多人实时聊天，
### 前端基础工具
### 论坛社区
### 微服务