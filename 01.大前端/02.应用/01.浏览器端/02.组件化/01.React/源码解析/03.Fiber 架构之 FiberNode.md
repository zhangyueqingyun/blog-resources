# React æºç è§£æï¼šç¬¬ä¸‰ç«  Fiber æ¶æ„ä¸ FiberNode

ğŸ˜† Hiï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¼ ç¥å¿äº‘ï¼Œä¸€ä¸ªé¢å‘æœªæ¥ç¼–ç¨‹çš„ç¨‹åºå‘˜ï¼å‡†å¤‡å°† React æºç è§£æå†™æˆä¸€ç³»åˆ—æ–‡ç« åˆ†äº«ç»™å¤§å®¶ï¼Œå¸Œæœ›å¤§å®¶å–œæ¬¢~ 

##  ä¸€ã€å‰è¨€

ä¸€ä¸ªæœ€ç®€å•çš„ React ç¨‹åºå¾€å¾€åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š

1. åˆ›å»º React å…ƒç´ æ ‘ï¼š

```javascript 
const element = React.createElement("div", {}, '');
```

2. åˆ›å»º FiberRoot èŠ‚ç‚¹å¹¶æŒ‚è½½åˆ° DOM å®¹å™¨èŠ‚ç‚¹ä¸Šï¼š

```javascript
const root = ReactDOM.createRoot(container);
```

3. FiberRoot æ¸²æŸ“ç¬¬ä¸€æ­¥åˆ›å»ºçš„ React å…ƒç´ æ ‘ï¼š

```javascript
root.render(element);
```

å‰ä¸¤ä¸ªç« èŠ‚æˆ‘ä»¬ä»‹ç»äº† ReactElement ä¸ FiberRoot çš„ç›¸å…³å†…å®¹ï¼Œä»Šå¤©æˆ‘ä»¬å°†è¦å¼€å§‹è¿›å…¥ç¬¬ä¸‰ä¸ªæ­¥éª¤ï¼šå…ƒç´ æ ‘çš„æ¸²æŸ“ã€‚å…ƒç´ æ ‘çš„æ¸²æŸ“æ˜¯ React æ¡†æ¶çš„é‡ç‚¹ï¼Œå®ƒåŒ…å« Fiber æ¶æ„çš„å®ç°ï¼ˆè™šæ‹Ÿ domï¼‰å’Œå¯¹çº¤ç¨‹çš„å®ç°ã€‚è¿™ä¸ªç« èŠ‚æˆ‘ä»¬ä¸»è¦ä»‹ç» Fiber æ¶æ„çš„ä¸€äº›å‰ç½®çŸ¥è¯†ç‚¹ï¼šâ€œFiber æ¶æ„ä¸ FiberNodeâ€ã€‚

## äºŒã€è®¤è¯† Fiber æ¶æ„ 

### 2.1 çº¤ç¨‹ï¼ˆFiberï¼‰

Fiber çº¤ç¨‹ç”¨äºåœ¨å•çº¿ç¨‹çš„ç¯å¢ƒå†…æ‰§è¡Œå¤šçº¿ç¨‹çš„ä»»åŠ¡ï¼ˆå³ç”¨æˆ·æ€çš„å¤šçº¿ç¨‹å®ç°ï¼‰ã€‚React Fiber æ¶æ„å®ç°äº†çº¤ç¨‹çš„æ€æƒ³ï¼Œå®ƒæŠŠè™šæ‹Ÿ DOM çš„æ›´æ–°ä»»åŠ¡åˆ’åˆ†ä¸ºç»†ç²’åº¦çš„ Fiber æ›´æ–°ä»»åŠ¡ï¼Œç”±è°ƒåº¦å™¨è°ƒåº¦æ‰§è¡Œã€‚è¿™ç§æ‰§è¡Œæœºåˆ¶è®©è™šæ‹Ÿ DOM çš„æ›´æ–°å’Œæµè§ˆå™¨çš„æ¸²æŸ“å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œé¿å…äº†æµè§ˆå™¨æ¸²æŸ“è¢«é˜»å¡çš„æƒ…å†µï¼Œå¹¶ä¸”å®ç°äº†æ›´æ–°ä»»åŠ¡çš„ä¸­æ–­å’Œé‡å¯ã€‚

### 2.2 Fiber æ¶æ„çš„å®ç°

Fiber æ¶æ„çš„ä¸­å¿ƒæ•°æ®ç»“æ„æ˜¯ Fiber æ ‘ï¼ˆæ ‘å½¢æ•°æ®ç»“æ„ï¼Œå¯¹åº” DOM æ ‘ï¼‰ã€‚åœ¨æºç ä¸­ï¼Œè¿™æ£µæ ‘çš„èŠ‚ç‚¹å«æœ‰å¯¹çˆ¶èŠ‚ç‚¹ã€å­©å­èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹çš„å¼•ç”¨ï¼Œå®ç°äº†ä»æ ‘çš„éå†åˆ°é“¾è¡¨çš„è®¿é—®çš„è½¬åŒ–ã€‚å¹¶ä¸”ä¸ºäº†é‡å¤åˆ©ç”¨ Fiber èŠ‚ç‚¹ï¼ŒReact åˆ›å»ºäº†ä¸¤é¢— Fiber æ ‘ï¼ˆcurrent æ ‘å’Œ workInProgress æ ‘ï¼‰äº¤æ›¿å·¥ä½œã€‚è¿™äº›ä¹‹åçš„ç« èŠ‚å°†ä¼šè¯¦ç»†ä»‹ç»ï¼Œä»Šå¤©æˆ‘ä»¬çš„ä¸»è¦å†…å®¹ä¸º Fiber æ ‘çš„èŠ‚ç‚¹ï¼šFiberNodeã€‚

## ä¸‰ã€Fiber æ ‘çš„èŠ‚ç‚¹

### 3.1 FiberNode

FiberNode æ˜¯ Fiber èŠ‚ç‚¹çš„ç±»å®ç°ï¼Œå…¶å†…éƒ¨åŒ…å«äº†åŸºæœ¬å±æ€§ã€æ ‘ï¼ˆé“¾è¡¨ï¼‰èŠ‚ç‚¹çš„å¼•ç”¨å±æ€§ã€å†…éƒ¨é€»è¾‘æ‰€éœ€çš„å±æ€§ç­‰ã€‚ä»¥ä¸‹å†…å®¹å°†è¯¦ç»†ä»‹ç» FiberNode åŠå…¶æ‰€æ‹¥æœ‰çš„å±æ€§ï¼š

åŸºæœ¬å±æ€§ï¼š

| å±æ€§ | æè¿° |
| ---- | ---- |
| tag | Fiber çš„ç±»å‹ã€‚ä¾‹å¦‚ FunctionComponent (å‡½æ•°ç»„ä»¶)ã€ClassComponentï¼ˆç±»ç»„ä»¶ï¼‰ã€‚ |
| elementType | ReactElement çš„ç±»å‹ã€‚ä¾‹å¦‚ REACT_ELEMENT_TYPEï¼ˆè‡ªå®šä¹‰å…ƒç´ ï¼‰ï¼ŒREACT_PORTAL_TYPEï¼ˆportalï¼‰ã€REACT_FRAGMENT_TYPE(Fragment)ç­‰ã€‚ |
| type | React.createElement çš„ç¬¬ä¸€ä¸ªå‚æ•° |
| stateNode | children å¯¹åº”çš„ ReactElement ï¼›å…¶ä»–çŠ¶æ€ä¿¡æ¯ã€‚ |
| return | çˆ¶èŠ‚ç‚¹çš„å¼•ç”¨ |
| child | å­èŠ‚ç‚¹çš„å¼•ç”¨ |
| sibling | å…„å¼ŸèŠ‚ç‚¹çš„å¼•ç”¨ |
| index | fiber åœ¨å…„å¼ŸèŠ‚ç‚¹ä¹‹é—´çš„ä½ç½® |
| key | åˆ¤æ–­ fiber èº«ä»½çš„æ ‡å¿— |
| ref | å¼•ç”¨ |
| pendingProps | å°†ä¼ é€’ç»™ç»„ä»¶çš„ props |
| memoizedProps | å½“å‰ props |
| updateQueue | æ›´æ–°é˜Ÿåˆ— |
| memoizedState | å½“å‰ state |
| dependencies | context ç›¸å…³é“¾è¡¨ |
| mode | æ¨¡å¼ |

é™¤äº†ä¸Šé¢åˆ—å‡ºçš„å±æ€§ï¼ŒFiberNode è¿˜æœ‰æ ‡å¿—ã€ä¼˜å…ˆçº§ã€æ€§èƒ½æµ‹é‡ç­‰å…¶ä»–ç±»å‹çš„å±æ€§ï¼Œè¿™é‡Œä¸è¿‡å¤šè®²è§£äº†ï¼Œæºç æ³¨é‡Šå¦‚ä¸‹ï¼š

```javascript 
function FiberNode(
    tag,
    pendingProps,
    key,
    mode,
) {
    /** ç±»å‹ */
    this.tag = tag;

    /** é”®å€¼ */
    this.key = key;

    /** ReactElement çš„ç±»å‹ */
    this.elementType = null;

    /** React.createElement çš„ç¬¬ä¸€ä¸ªå‚æ•° */
    this.type = null;

    /** children çš„ ReactElement æˆ–å…¶ä»–çŠ¶æ€ä¿¡æ¯ã€‚ */
    this.stateNode = null;    


    /** çˆ¶èŠ‚ç‚¹å¼•ç”¨ */
    this.return = null;

    /** ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹çš„å¼•ç”¨ */
    this.child = null;

    /** å…„å¼ŸèŠ‚ç‚¹çš„å¼•ç”¨ */
    this.sibling = null;

    /** åœ¨å…„å¼ŸèŠ‚ç‚¹ä¸­çš„ä½ç½® */
    this.index = 0;


    /** å¼•ç”¨ */
    this.ref = null;


    /** å°†ä¼ é€’ç»™ç»„ä»¶çš„ props */
    this.pendingProps = pendingProps;

    /** å½“å‰ props */
    this.memoizedProps = null;

    /** æ›´æ–°é˜Ÿåˆ— */
    this.updateQueue = null;

    /** å½“å‰ state */
    this.memoizedState = null;

    /** context ç›¸å…³é“¾è¡¨ */
    this.dependencies = null;


    /** æ¨¡å¼ */
    this.mode = mode;


    /** React å·¥ä½œæµç¨‹ä¸­çš„ä¸€äº›æ ‡å¿—ä½ */
    this.flags = NoFlags;
    this.subtreeFlags = NoFlags;
    this.deletions = null;


    /** ä¼˜å…ˆçº§ç›¸å…³çš„å±æ€§ */
    this.lanes = NoLanes;
    this.childLanes = NoLanes;


    /** current æ ‘çš„èŠ‚ç‚¹å’Œ alternate æ ‘çš„èŠ‚ç‚¹ç›¸äº’å¼•ç”¨çš„å±æ€§ */
    this.alternate = null;


    /** æµ‹é‡æ€§èƒ½æ—¶ä½¿ç”¨åˆ°çš„ä¸€äº›å±æ€§ */ 
    if (enableProfilerTimer) {
        this.actualDuration = Number.NaN;
        this.actualStartTime = Number.NaN;
        this.selfBaseDuration = Number.NaN;
        this.treeBaseDuration = Number.NaN;

        this.actualDuration = 0;
        this.actualStartTime = -1;
        this.selfBaseDuration = 0;
        this.treeBaseDuration = 0;
    }
}
```

#### 3.2 Fiber çš„ç±»åˆ« ï¼ˆfiber.tagï¼‰

ä¸Šé¢ç½—åˆ—äº† FiberNode çš„å±æ€§ï¼Œç°åœ¨å…·ä½“æ¥çœ‹ tag å±æ€§ã€‚tag å±æ€§ä»£è¡¨ FiberNode çš„ç±»åˆ«ï¼ŒReact å¯¹æ¯ç±» FiberNode é‡‡å–ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œä¾‹å¦‚ç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶åœ¨ React æºç å†…çš„å¤„ç†æ–¹å¼å°±æ˜¯å¾ˆä¸ç›¸åŒçš„ï¼Œè¿™ä¸ªä»¥åæˆ‘ä»¬ä¼šè¯¦ç»†è®²è§£ã€‚ç°åœ¨æˆ‘ä»¬å…ˆç®€å•äº†è§£ä¸‹ Fiber èŠ‚ç‚¹éƒ½æœ‰å“ªäº›ç±»åˆ«ï¼š

| ç±»åˆ« | æè¿° |
| ---- | ---- |
| FunctionComponent | å‡½æ•°ç»„ä»¶ |
| ClassComponent | ç±»ç»„ä»¶ |
| IndeterminateComponent | å‡½æ•°ç»„ä»¶æˆ–ç±»ç»„ä»¶ |
| HostRoot | Fiber æ ‘çš„æ ¹èŠ‚ç‚¹ |
| HostPortal | Portal èŠ‚ç‚¹ |
| HostComponent | DOM å…ƒç´  |
| HostText | DOM ä¸­çš„ Text ç±»å‹ |
| Fragment | Fragment |
| Mode | StrictMode |
| ContextConsumer | Context.Consumer |
| ContextProvider | Context.Provider |
| ForwardRef | forwardRef |
| Profiler | Profiler |
| SuspenseComponent | Suspense |
| MemoComponent | React.memo |

æºä»£ç å¦‚ä¸‹ï¼š

```javascript
/** å‡½æ•°ç»„ä»¶ */
export const FunctionComponent = 0;

/** ç±»ç»„ä»¶ */
export const ClassComponent = 1;

/** å‡½æ•°ç»„ä»¶æˆ–ç±»ç»„ä»¶ */
export const IndeterminateComponent = 2;

/** Fiber æ ‘çš„æ ¹èŠ‚ç‚¹ */
export const HostRoot = 3;

/** Portal èŠ‚ç‚¹ */
export const HostPortal = 4;

/** DOM å…ƒç´  */
export const HostComponent = 5;

/** DOM ä¸­çš„ Text ç±»å‹ */
export const HostText = 6;

/** Fragment */
export const Fragment = 7;

/** StrictMode */
export const Mode = 8;

/** Context.Consumer */
export const ContextConsumer = 9;

/** Context.Provider */
export const ContextProvider = 10;

/** forwardRef */
export const ForwardRef = 11;

/** Profiler */
export const Profiler = 12;

/** Suspense */
export const SuspenseComponent = 13;

/** React.memo */
export const MemoComponent = 14;

/** React.memo */
export const SimpleMemoComponent = 15;

/** React.lazy */
export const LazyComponent = 16;

/** æœªå®Œæˆçš„ç±»ç»„ä»¶ */
export const IncompleteClassComponent = 17;

/** æœªå®Œæˆçš„ç±»ç»„ä»¶ */
export const DehydratedFragment = 18;

/** SuspenseList */
export const SuspenseListComponent = 19;

/** React Scope */
export const ScopeComponent = 21;

/** ç¦»å±ç»„ä»¶ */
export const OffscreenComponent = 22;


// ä»¥ä¸‹ç±»å‹æ—¥åç ”ç©¶
//
// /** è¿˜æ²¡çœ‹è¿™éƒ¨åˆ†ä»£ç  */
// export const LegacyHiddenComponent = 23;

// /** è¿˜æ²¡çœ‹è¿™éƒ¨åˆ†ä»£ç  */
// export const CacheComponent = 24;

// /** è¿˜æ²¡çœ‹è¿™éƒ¨åˆ†ä»£ç  */
// export const TracingMarkerComponent = 25;
```

#### 3.3 Fiber çš„å·¥ä½œæ¨¡å¼ ï¼ˆfiber.modeï¼‰

æ¨¡å¼å†³å®šäº† React é‡‡ç”¨ä»€ä¹ˆç­–ç•¥å»å¤„ç† Fiber èŠ‚ç‚¹ã€‚ä¾‹å¦‚ Concurrent æ¨¡å¼é‡‡ç”¨äº†æ—¶é—´åˆ†ç‰‡çš„å¹¶å‘æ¨¡å¼ã€Profile æ¨¡å¼é‡‡ç”¨äº†æ€§èƒ½åˆ†ææ¨¡å¼ã€DebugTracing å¼€å¯äº†è°ƒè¯•æ¨¡å¼ç­‰ï¼Œè¿™äº›æ¨¡å¼æ˜¯å¯ä»¥åŒæ—¶å­˜åœ¨çš„ã€‚

| æ¨¡å¼ | æè¿° |
| ---- | ---- |
| NoMode | æ— æ¨¡å¼ |
| ConcurrentMode | å¹¶å‘æ¨¡å¼ |
| ProfileMode | æ€§èƒ½åˆ†ææ¨¡å¼ |
| DebugTracingMode | è°ƒè¯•æ¨¡å¼ |
| StrictLegacyMode | StrictMode |
| StrictEffectsMode | StrictMode && enableStrictEffects |
| ConcurrentUpdatesByDefaultMode | å¹¶å‘æ¨¡å¼ä¸‹ lane ä½¿ç”¨è¢«èµ‹äºˆçš„ lane æ¨¡å¼ |

```javascript
/** æ— æ¨¡å¼ */
export const NoMode = /*                         */ 0b000000;    

/** å¹¶å‘æ¨¡å¼ */
export const ConcurrentMode = /*                 */ 0b000001;

/** æ€§èƒ½åˆ†ææ¨¡å¼ */
export const ProfileMode = /*                    */ 0b000010;

/** è°ƒè¯•æ¨¡å¼ */
export const DebugTracingMode = /*               */ 0b000100;

/** StrictMode */
export const StrictLegacyMode = /*               */ 0b001000;    

/** StrictMode && enableStrictEffects */
export const StrictEffectsMode = /*              */ 0b010000;

/** å¹¶å‘æ¨¡å¼ä¸‹ lane ä½¿ç”¨è¢«èµ‹äºˆçš„ lane æ¨¡å¼ */
export const ConcurrentUpdatesByDefaultMode = /* */ 0b100000;
```

#### 3.4 ReactElement çš„ç±»å‹ï¼ˆfiber.elementTypeï¼‰

elementType å±æ€§åˆ™ä»£è¡¨äº† ReactElement çš„ç±»å‹ï¼Œæºç å¦‚ä¸‹ï¼š

```javascript
/** ReactElement */
export const REACT_ELEMENT_TYPE = Symbol.for('react.element');

/** Protal */
export const REACT_PORTAL_TYPE = Symbol.for('react.portal');

/** Fragment */
export const REACT_FRAGMENT_TYPE = Symbol.for('react.fragment');

/** StrictMode */
export const REACT_STRICT_MODE_TYPE = Symbol.for('react.strict_mode');

/** Profiler */
export const REACT_PROFILER_TYPE = Symbol.for('react.profiler');

/** Provider */
export const REACT_PROVIDER_TYPE = Symbol.for('react.provider');

/** Context */
export const REACT_CONTEXT_TYPE = Symbol.for('react.context');
export const REACT_SERVER_CONTEXT_TYPE = Symbol.for(
  'react.server_context',
);

/** forwardRef */
export const REACT_FORWARD_REF_TYPE = Symbol.for('react.forward_ref');

/** Suspense */
export const REACT_SUSPENSE_TYPE = Symbol.for('react.suspense');

/** SuspenseList */
export const REACT_SUSPENSE_LIST_TYPE = Symbol.for(
  'react.suspense_list',
);

/** React.memo */
export const REACT_MEMO_TYPE = Symbol.for('react.memo');

/** React.lazy */
export const REACT_LAZY_TYPE = Symbol.for('react.lazy');

/** React Scope */
export const REACT_SCOPE_TYPE = Symbol.for('react.scope');

/** è°ƒè¯•æ¨¡å¼ */
export const REACT_DEBUG_TRACING_MODE_TYPE = Symbol.for(
  'react.debug_trace_mode',
);

/** ç¦»å±ç»„ä»¶ */
export const REACT_OFFSCREEN_TYPE = Symbol.for('react.offscreen');

// ä»¥ä¸‹ç±»å‹æ—¥åç ”ç©¶
// 
// export const REACT_LEGACY_HIDDEN_TYPE = Symbol.for(
//   'react.legacy_hidden',
// );
// export const REACT_CACHE_TYPE = Symbol.for('react.cache');
// export const REACT_TRACING_MARKER_TYPE = Symbol.for(
//   'react.tracing_marker',
// );
// export const REACT_SERVER_CONTEXT_DEFAULT_VALUE_NOT_LOADED = Symbol.for(
//   'react.default_value',
// );
// export const REACT_MEMO_CACHE_SENTINEL = Symbol.for(
//   'react.memo_cache_sentinel',
// );

```

## å››ã€FiberNode çš„åˆ›å»º

ä¸Šé¢å†…å®¹ç®€ç•¥ä»‹ç»äº† FiberNode ç±»ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹å¦‚ä½•åˆ›å»º FiberNodeï¼Œå³ Fiber Node çš„å·¥å‚å‡½æ•°ã€‚createFiber æ˜¯ FiberNode æœ€ç›´æ¥çš„å·¥å‚å‡½æ•°ï¼Œæ‰€æœ‰ Fiber çš„åˆ›å»ºéƒ½è¦é€šè¿‡å®ƒæ¥å®Œæˆï¼š

```javascript
const createFiber = function(
    tag,
    pendingProps,
    key,
    mode,
) {
    /** è¿”å› FiberNode å®ä¾‹ */
    return new FiberNode(tag, pendingProps, key, mode);
};
```

åœ¨ create Fiber ä¹‹ä¸Šè¿˜æœ‰ä¸€äº›åˆ›å»ºç‰¹å®šç±»åˆ« fiber çš„å·¥å‚å‡½æ•°ï¼Œä¾‹å¦‚ createFiberFromElementã€createHostRootFiberã€createFiberFromProfiler ç­‰ï¼Œæ¯ä¸ªå·¥å‚å‡½æ•°ä¼šè®¾ç½®è¯¥ç±» Fiber æ‰€å¯¹åº”çš„å„ç§å±æ€§ï¼ˆä¾‹å¦‚ elementType ç­‰ï¼‰ã€‚æœ¬ç« æˆ‘ä»¬å°†ç”¨åˆ›å»º ReactElement å¯¹åº”çš„ Fiber çš„å·¥å‚å‡½æ•°ä½œä¸ºä¾‹å­æ¥è®²è§£ã€‚

#### 4.1 åˆ›å»º ReactElement å¯¹åº”çš„ Fiber

createFiberFromElement æ˜¯åˆ›å»º ReactElement æ‰€å¯¹åº”çš„ Fiber çš„å·¥å‚å‡½æ•°ã€‚å®ƒè°ƒç”¨äº†å¦å¤–ä¸€ä¸ªè´Ÿå‡½æ•°æ¥åˆ›å»º fiberï¼ˆcreateFiberFromTypeAndPropsï¼‰ã€‚

```javascript
    export function createFiberFromElement(
    element,
    mode,
    lanes,
) {
    let owner = null;
    const type = element.type;
    const key = element.key;
    const pendingProps = element.props;

    /** è°ƒç”¨ createFiberFromTypeAndProps åˆ›å»º fiber */
    const fiber = createFiberFromTypeAndProps(
        type,
        key,
        pendingProps,
        owner,
        mode,
        lanes,
    );

    return fiber;
}
```

createFiberFromTypeAndProps ä¼šæ ¹æ®ä¸åŒçš„ type æ¥ä¸ºä¸åŒçš„ ReactElement åˆ›å»º fiber ï¼Œå®ƒçš„åˆ¤æ–­æ­¥éª¤å¦‚ä¸‹ï¼š

1. å¤„ç† ClassComponent å¹¶è·å– tag
2. å¤„ç† HostComponent å¹¶è·å– tag
3. å¤„ç† Fragmentã€StrictModeã€Profilerã€Suspenseã€SuspenseList ç­‰èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ç›¸åº”å·¥å‚å‡½æ•°è¿”å› fiber
4. å¤„ç† Contextã€React.memoã€React.lazyã€forwardRef ç­‰ api åˆ›å»ºçš„èŠ‚ç‚¹å¹¶è·å– tag
5. è°ƒç”¨ createFiber å·¥å‚å‡½æ•°åˆ›å»º fiber å¹¶è¿”å›
æºç è§£æå¦‚ä¸‹ï¼š

```javascript
export function createFiberFromTypeAndProps(
    type, 
    key,
    pendingProps,
    owner,
    mode,
    lanes,
) {

    /** è®¾ç½® tag ä¸º IndeterminateComponent */
    let fiberTag = IndeterminateComponent;

    let resolvedType = type;

    /** åˆ¤æ–­æ˜¯å¦ä¸ºç±»ç»„ä»¶ï¼Œè‹¥ä¸ºç±»ç»„ä»¶ï¼Œåˆ™è®¾ç½® tag ä¸º ClassComponent */
    if (typeof type === 'function') {
        if (shouldConstruct(type)) {
            fiberTag = ClassComponent;
        } 
    /** åˆ¤æ–­æ˜¯å¦ä¸º DOM å…ƒç´ å¯¹åº”çš„ ReactElementï¼Œè‹¥æ˜¯åˆ™è®¾ç½® tag ä¸º HostComponent */
    } else if (typeof type === 'string') {
        fiberTag = HostComponent;
    } else {
        getTag: switch (type) {

            /** å¤„ç† Fragment èŠ‚ç‚¹ */
            case REACT_FRAGMENT_TYPE:
                return createFiberFromFragment(pendingProps.children, mode, lanes, key);
            
            /** å¤„ç† StrictMode èŠ‚ç‚¹ */
            case REACT_STRICT_MODE_TYPE:
                fiberTag = Mode;
                mode |= StrictLegacyMode;
                if (enableStrictEffects && (mode & ConcurrentMode) !== NoMode) {
                    // Strict effects should never run on legacy roots
                    mode |= StrictEffectsMode;
                }
                break;

            /** å¤„ç† Profiler èŠ‚ç‚¹ */
            case REACT_PROFILER_TYPE:
                return createFiberFromProfiler(pendingProps, mode, lanes, key);
            
            /** å¤„ç† Suspense èŠ‚ç‚¹ */
            case REACT_SUSPENSE_TYPE:
                return createFiberFromSuspense(pendingProps, mode, lanes, key);
            
            /** å¤„ç† SuspenseList èŠ‚ç‚¹ */
            case REACT_SUSPENSE_LIST_TYPE:
                return createFiberFromSuspenseList(pendingProps, mode, lanes, key);
            
            /** å¤„ç†ç¦»å±ç»„ä»¶ */
            case REACT_OFFSCREEN_TYPE:
                return createFiberFromOffscreen(pendingProps, mode, lanes, key);
            case REACT_LEGACY_HIDDEN_TYPE:
                if (enableLegacyHidden) {
                    return createFiberFromLegacyHidden(pendingProps, mode, lanes, key);
                }
            case REACT_SCOPE_TYPE:
                if (enableScopeAPI) {
                    return createFiberFromScope(type, pendingProps, mode, lanes, key);
                }
            case REACT_CACHE_TYPE:
                if (enableCache) {
                    return createFiberFromCache(pendingProps, mode, lanes, key);
                }
            case REACT_TRACING_MARKER_TYPE:
                if (enableTransitionTracing) {
                    return createFiberFromTracingMarker(pendingProps, mode, lanes, key);
                }
            case REACT_DEBUG_TRACING_MODE_TYPE:
                if (enableDebugTracing) {
                    fiberTag = Mode;
                    mode |= DebugTracingMode;
                    break;
                }
            // eslint-disable-next-line no-fallthrough
            default: {
                
                /** å¤„ç†è‡ªå®šä¹‰ç»„ä»¶ */
                if (typeof type === 'object' && type !== null) {
                    switch (type.$$typeof) {
                
                        /** å¤„ç† Context.Provider */
                        case REACT_PROVIDER_TYPE:
                            fiberTag = ContextProvider;
                            break getTag;
                        
                        /** å¤„ç† Context.Consumer */
                        case REACT_CONTEXT_TYPE:
                            fiberTag = ContextConsumer;
                            break getTag;
                        
                        /** å¤„ç† forwardRef */
                        case REACT_FORWARD_REF_TYPE:
                            fiberTag = ForwardRef;
                            break getTag;
                        
                        /** å¤„ç† React.memo */
                        case REACT_MEMO_TYPE:
                            fiberTag = MemoComponent;
                            break getTag;
                        
                        /** å¤„ç† React.lazy */
                        case REACT_LAZY_TYPE:
                            fiberTag = LazyComponent;
                            resolvedType = null;
                            break getTag;
                    }
                }
                let info = '';

                throw new Error(
                'Element type is invalid: expected a string (for built-in ' +
                    'components) or a class/function (for composite components) ' +
                    `but got: ${type == null ? type : typeof type}.${info}`,
                );
            }
        }
    }
    
    /** åˆ›å»º fiber */
    const fiber = createFiber(fiberTag, pendingProps, key, mode);
    fiber.elementType = type;
    fiber.type = resolvedType;
    fiber.lanes = lanes;

    return fiber;
}
```

## äº”ã€ç»“å°¾

è¿™äº›å°±æ˜¯ FiberNode å³å…¶åˆ›å»ºçš„å…¨è¿‡ç¨‹å•¦ï¼ æ¬¢è¿å°ä¼™ä¼´ä»¬ä¸€èµ·è®¨è®º~ @V@ ~

æœ€åæ¥åˆ™å¹¿å‘Š @v@~

> âœ¨ å¸ƒçµå¸ƒçµï¼YQY ä½ä»£ç å¹³å°é¦–å‘å•¦ï¼
> ---
> 
> #### ğŸ“ åŸºæœ¬åŠŸèƒ½
> 
> - é€šè¿‡æ‹–æ‹½è‡ªåŠ¨ç”Ÿæˆ React é¡¹ç›®ä»£ç ï¼ˆåŒ…å«è·¯ç”±ã€å¸ƒå±€ã€é¡µé¢ã€ç»„ä»¶ã€cssæ ·å¼ï¼‰ã€‚
> - è‡ªåŠ¨åŒ–ç”Ÿæˆä»£ç ä»“åº“ã€‚
> - è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - å¿«æ·è®¿é—®éƒ¨ç½²çš„é¡¹ç›®ã€é¡µé¢ã€‚
> - é€šè¿‡ä½ä»£ç å¹³å°å¯¹å·²ç”Ÿæˆçš„é¡¹ç›®è¿›è¡Œä¿®æ”¹ã€‚
> - æ‹‰å–é¡¹ç›®è‡³æœ¬åœ°ï¼Œç”±å¼€å‘äººå‘˜æ‰‹åŠ¨å¼€å‘ï¼Œæ¨é€åˆ°è¿œç¨‹ä»“åº“åè‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - æ¥å…¥ä¸åŒç»„ä»¶åº“ã€‚
> - æ”¯æŒæ¥å…¥åŸ‹ç‚¹ã€ç›‘æ§ç­‰å‰ç«¯æ¶æ„ã€‚
> 
> #### ğŸ“ ä¼˜ç‚¹
> 
> - ç”Ÿæˆçš„ä»£ç å¯è¯»æ€§å¥½ï¼ŒåŒ…å«æ³¨é‡Šã€‚
> - å¯ç”Ÿæˆä¸åŒç±»å‹çš„ç»„ä»¶ï¼ˆå‡½æ•°ç»„ä»¶ã€ç±»ç»„ä»¶ï¼‰ã€‚
> - å¯è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®ã€å¸ƒå±€ã€é¡µé¢ã€è·¯ç”±ç­‰ã€‚
> - æ”¯æŒè‡ªåŠ¨åˆ›å»ºä»£ç ä»“åº“ã€è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - æ”¯æŒæ¥å…¥ä¸åŒç»„ä»¶åº“ã€‚
> - æ”¯æŒæ¥å…¥åŸ‹ç‚¹ã€ç›‘æ§ç­‰ä¼ä¸šçº§å‰ç«¯æ¶æ„ã€‚
> 
> ğŸ˜ˆ å¦‚æ„Ÿå…´è¶£ï¼Œå¯è”ç³»æœ¬äººï¼šå¼ å¤§å¯çˆ±å®å® 
> 
> - tel: 16602927079 
> - email: zhangyueqingyun@foxmail.com
> - wechat: abcde-ovo-yz
> 
> ğŸ¼ å…¶ä»–
> ---
> 
> - ğŸ‹ [ä¸ªäººåšå®¢](https://zhangyueqingyun.tech)
> - ğŸ’ [ç®—æ³•æµ‹è¯•æ¡†æ¶](https://github.com/zhangyueqingyun/algorithm)
> - ğŸ“ [å‰ç«¯åŸåˆ›èµ„æº](https://github.com/zhangyueqingyun/blog-resources)
