# React æºç è§£æï¼šç¬¬ä¸‰ç«  Fiber æ¶æ„ä¹‹ FiberNode 

ğŸ˜† Hiï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¼ ç¥å¿äº‘ï¼Œä¸€ä¸ªé¢å‘æœªæ¥ç¼–ç¨‹çš„ç¨‹åºå‘˜ï¼å‡†å¤‡å°† React æºç è§£æå†™æˆä¸€ç³»åˆ—æ–‡ç« åˆ†äº«ç»™å¤§å®¶ï¼Œå¸Œæœ›å¤§å®¶å–œæ¬¢~ 

##  ä¸€ã€å‰è¨€

ä¸€ä¸ªæœ€ç®€å•çš„ React ç¨‹åºå¾€å¾€åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š

1. åˆ›å»º React å…ƒç´ æ ‘ï¼š

```javascript 
const element = React.createElement("div", {}, '');
```

2. åˆ›å»º FiberRoot èŠ‚ç‚¹å¹¶æŒ‚è½½åˆ° DOM å®¹å™¨èŠ‚ç‚¹ä¸Šï¼š

```javascript
const root = ReactDOM.createRoot(container);
```

3. FiberRoot æ¸²æŸ“ç¬¬ä¸€æ­¥åˆ›å»ºçš„ React å…ƒç´ æ ‘ï¼š

```javascript
root.render(element);
```

ç”±äºç¬¬ä¸‰æ­¥å…ƒç´ æ ‘çš„æ¸²æŸ“æ¯”è¾ƒå¤æ‚ï¼Œæ˜¯ React æ¡†æ¶çš„é‡ä¸­ä¹‹é‡ï¼Œæˆ‘ä»¬åˆ†æˆå‡ ä¸ªç« èŠ‚æ¥è®²è§£ã€‚è¿™ä¸€ç« ä¸»è¦ç”± root.render() è¿™ä¸ª api èµ·å§‹ï¼Œé‡ç‚¹è®²è¿° Fiber æ ‘ç¬¬ä¸€æ¬¡çš„æ„å»ºã€‚

## äºŒã€è®¤è¯† Fiber æ ‘

ä»€ä¹ˆæ˜¯ Fiber æ ‘å‘¢ï¼Ÿ Fiber æ ‘æ˜¯ React å†…éƒ¨æ„å»ºçš„ï¼Œç”¨äºæ¸²æŸ“ç½‘é¡µçš„ä¸€ç§å†…éƒ¨æ ‘å½¢ç»“æ„ï¼Œè™½ç„¶æ˜¯å±‚çº§å‹çš„æ•°æ®ï¼Œä½†æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„æŒ‡é’ˆè®©è®¿é—®è¿™æ£µæ ‘å˜æˆäº†ç±»ä¼¼é“¾è¡¨çš„é¡ºåºè®¿é—®ã€‚

FiberNode çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†å†…éƒ¨æ“ä½œæœ‰å…³çš„ä¿¡æ¯ã€‚

## ä¸‰ã€Fiber æ ‘çš„èŠ‚ç‚¹


### 3.1 FiberNode

```javascript 
function FiberNode(
  tag,
  pendingProps,
  key,
  mode,
) {
  // Instance
  this.tag = tag;
  this.key = key;
  this.elementType = null;
  this.type = null;
  this.stateNode = null;

  // Fiber
  this.return = null;    // çˆ¶èŠ‚ç‚¹
  this.child = null;    // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
  this.sibling = null;    // å…„å¼ŸèŠ‚ç‚¹
  this.index = 0;

  this.ref = null;    

  this.pendingProps = pendingProps;
  this.memoizedProps = null;
  this.updateQueue = null;
  this.memoizedState = null;
  this.dependencies = null;

  this.mode = mode;

  // Effects
  this.flags = NoFlags;
  this.subtreeFlags = NoFlags;
  this.deletions = null;

  this.lanes = NoLanes;
  this.childLanes = NoLanes;

  this.alternate = null;

  if (enableProfilerTimer) {
    this.actualDuration = Number.NaN;
    this.actualStartTime = Number.NaN;
    this.selfBaseDuration = Number.NaN;
    this.treeBaseDuration = Number.NaN;

    this.actualDuration = 0;
    this.actualStartTime = -1;
    this.selfBaseDuration = 0;
    this.treeBaseDuration = 0;
  }
}
```

#### 3.2 èŠ‚ç‚¹ç±»å‹

Fiber èŠ‚ç‚¹çš„ç±»å‹

```javascript
export const FunctionComponent = 0;    // å‡½æ•°ç»„ä»¶
export const ClassComponent = 1;    // ç±»ç»„ä»¶
export const IndeterminateComponent = 2;    //ä¸­é—´ç»„ä»¶ ï¼ˆæœªçŸ¥æ˜¯å‡½æ•°ç»„ä»¶æˆ–ç±»ç»„ä»¶ï¼‰
export const HostRoot = 3;  // Fiber æ ‘çš„æ ¹èŠ‚ç‚¹.
export const HostPortal = 4;     // Portal åŠŸèƒ½çš„èŠ‚ç‚¹ï¼Œå¯èƒ½æ˜¯å¦å¤–ä¸€ä¸ªæ¸²æŸ“çš„å…¥å£.
export const HostComponent = 5;
export const HostText = 6;
export const Fragment = 7;      
export const Mode = 8;
export const ContextConsumer = 9;
export const ContextProvider = 10;
export const ForwardRef = 11;
export const Profiler = 12;
export const SuspenseComponent = 13;
export const MemoComponent = 14;
export const SimpleMemoComponent = 15;
export const LazyComponent = 16;
export const IncompleteClassComponent = 17;
export const DehydratedFragment = 18;
export const SuspenseListComponent = 19;
export const ScopeComponent = 21;
export const OffscreenComponent = 22;    // ç¦»å±ç»„ä»¶
export const LegacyHiddenComponent = 23;
export const CacheComponent = 24;
export const TracingMarkerComponent = 25;

```

#### 3.3 Fiber èŠ‚ç‚¹æ¨¡å¼

```javascript
export const NoMode = /*                         */ 0b000000;    // æ— æ¨¡å¼
export const ConcurrentMode = /*                 */ 0b000001;    // å¹¶è¡Œæ¨¡å¼
export const ProfileMode = /*                    */ 0b000010;    // åˆ†ææ¨¡å¼
export const DebugTracingMode = /*               */ 0b000100;    // è°ƒå¼æ¨¡å¼
export const StrictLegacyMode = /*               */ 0b001000;    
export const StrictEffectsMode = /*              */ 0b010000;
export const ConcurrentUpdatesByDefaultMode = /* */ 0b100000;
```

## å››ã€FiberNode çš„åˆ›å»º

```javascript
const createFiber = function(
  tag,
  pendingProps,
  key,
  mode,
) {
  return new FiberNode(tag, pendingProps, key, mode);
};
```

#### 4.1 åˆ›å»º ReactElement å¯¹åº”çš„ Fiber
```javascript
 export function createFiberFromElement(
  element,
  mode,
  lanes,
) {
  let owner = null;
  const type = element.type;
  const key = element.key;
  const pendingProps = element.props;
  const fiber = createFiberFromTypeAndProps(
    type,
    key,
    pendingProps,
    owner,
    mode,
    lanes,
  );
  return fiber;
}

```

```javascript
export function createFiberFromTypeAndProps(
  type, // React$ElementType
  key,
  pendingProps,
  owner,
  mode,
  lanes,
) {
  let fiberTag = IndeterminateComponent;
  // The resolved type is set if we know what the final type will be. I.e. it's not lazy.
  let resolvedType = type;
  if (typeof type === 'function') {
    if (shouldConstruct(type)) {
      fiberTag = ClassComponent;
    } 
  } else if (typeof type === 'string') {
    fiberTag = HostComponent;
  } else {
    getTag: switch (type) {
      case REACT_FRAGMENT_TYPE:
        return createFiberFromFragment(pendingProps.children, mode, lanes, key);
      case REACT_STRICT_MODE_TYPE:
        fiberTag = Mode;
        mode |= StrictLegacyMode;
        if (enableStrictEffects && (mode & ConcurrentMode) !== NoMode) {
          // Strict effects should never run on legacy roots
          mode |= StrictEffectsMode;
        }
        break;
      case REACT_PROFILER_TYPE:
        return createFiberFromProfiler(pendingProps, mode, lanes, key);
      case REACT_SUSPENSE_TYPE:
        return createFiberFromSuspense(pendingProps, mode, lanes, key);
      case REACT_SUSPENSE_LIST_TYPE:
        return createFiberFromSuspenseList(pendingProps, mode, lanes, key);
      case REACT_OFFSCREEN_TYPE:
        return createFiberFromOffscreen(pendingProps, mode, lanes, key);
      case REACT_LEGACY_HIDDEN_TYPE:
        if (enableLegacyHidden) {
          return createFiberFromLegacyHidden(pendingProps, mode, lanes, key);
        }
      // eslint-disable-next-line no-fallthrough
      case REACT_SCOPE_TYPE:
        if (enableScopeAPI) {
          return createFiberFromScope(type, pendingProps, mode, lanes, key);
        }
      // eslint-disable-next-line no-fallthrough
      case REACT_CACHE_TYPE:
        if (enableCache) {
          return createFiberFromCache(pendingProps, mode, lanes, key);
        }
      // eslint-disable-next-line no-fallthrough
      case REACT_TRACING_MARKER_TYPE:
        if (enableTransitionTracing) {
          return createFiberFromTracingMarker(pendingProps, mode, lanes, key);
        }
      // eslint-disable-next-line no-fallthrough
      case REACT_DEBUG_TRACING_MODE_TYPE:
        if (enableDebugTracing) {
          fiberTag = Mode;
          mode |= DebugTracingMode;
          break;
        }
      // eslint-disable-next-line no-fallthrough
      default: {
        if (typeof type === 'object' && type !== null) {
          switch (type.$$typeof) {
            case REACT_PROVIDER_TYPE:
              fiberTag = ContextProvider;
              break getTag;
            case REACT_CONTEXT_TYPE:
              // This is a consumer
              fiberTag = ContextConsumer;
              break getTag;
            case REACT_FORWARD_REF_TYPE:
              fiberTag = ForwardRef;
              break getTag;
            case REACT_MEMO_TYPE:
              fiberTag = MemoComponent;
              break getTag;
            case REACT_LAZY_TYPE:
              fiberTag = LazyComponent;
              resolvedType = null;
              break getTag;
          }
        }
        let info = '';

        throw new Error(
          'Element type is invalid: expected a string (for built-in ' +
            'components) or a class/function (for composite components) ' +
            `but got: ${type == null ? type : typeof type}.${info}`,
        );
      }
    }
  }

  const fiber = createFiber(fiberTag, pendingProps, key, mode);
  fiber.elementType = type;
  fiber.type = resolvedType;
  fiber.lanes = lanes;

  return fiber;
}
```

#### 4.2 å…¶ä»–



## äº”ã€ç»“å°¾

è¿™äº›å°±æ˜¯ FiberRoot åˆ›å»ºåŠæŒ‚è½½çš„å…¨è¿‡ç¨‹å•¦ï¼ æ¬¢è¿å°ä¼™ä¼´ä»¬ä¸€èµ·è®¨è®º~ @V@ ~

æœ€åæ¥åˆ™å¹¿å‘Š @v@~

> âœ¨ å¸ƒçµå¸ƒçµï¼YQY ä½ä»£ç å¹³å°é¦–å‘å•¦ï¼
> ---
> 
> #### ğŸ“ åŸºæœ¬åŠŸèƒ½
> 
> - é€šè¿‡æ‹–æ‹½è‡ªåŠ¨ç”Ÿæˆ React é¡¹ç›®ä»£ç ï¼ˆåŒ…å«è·¯ç”±ã€å¸ƒå±€ã€é¡µé¢ã€ç»„ä»¶ã€cssæ ·å¼ï¼‰ã€‚
> - è‡ªåŠ¨åŒ–ç”Ÿæˆä»£ç ä»“åº“ã€‚
> - è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - å¿«æ·è®¿é—®éƒ¨ç½²çš„é¡¹ç›®ã€é¡µé¢ã€‚
> - é€šè¿‡ä½ä»£ç å¹³å°å¯¹å·²ç”Ÿæˆçš„é¡¹ç›®è¿›è¡Œä¿®æ”¹ã€‚
> - æ‹‰å–é¡¹ç›®è‡³æœ¬åœ°ï¼Œç”±å¼€å‘äººå‘˜æ‰‹åŠ¨å¼€å‘ï¼Œæ¨é€åˆ°è¿œç¨‹ä»“åº“åè‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - æ¥å…¥ä¸åŒç»„ä»¶åº“ã€‚
> - æ”¯æŒæ¥å…¥åŸ‹ç‚¹ã€ç›‘æ§ç­‰å‰ç«¯æ¶æ„ã€‚
> 
> #### ğŸ“ ä¼˜ç‚¹
> 
> - ç”Ÿæˆçš„ä»£ç å¯è¯»æ€§å¥½ï¼ŒåŒ…å«æ³¨é‡Šã€‚
> - å¯ç”Ÿæˆä¸åŒç±»å‹çš„ç»„ä»¶ï¼ˆå‡½æ•°ç»„ä»¶ã€ç±»ç»„ä»¶ï¼‰ã€‚
> - å¯è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®ã€å¸ƒå±€ã€é¡µé¢ã€è·¯ç”±ç­‰ã€‚
> - æ”¯æŒè‡ªåŠ¨åˆ›å»ºä»£ç ä»“åº“ã€è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - æ”¯æŒæ¥å…¥ä¸åŒç»„ä»¶åº“ã€‚
> - æ”¯æŒæ¥å…¥åŸ‹ç‚¹ã€ç›‘æ§ç­‰ä¼ä¸šçº§å‰ç«¯æ¶æ„ã€‚
> 
> ğŸ˜ˆ å¦‚æ„Ÿå…´è¶£ï¼Œå¯è”ç³»æœ¬äººï¼šå¼ å¤§å¯çˆ±å®å® 
> 
> - tel: 16602927079 
> - email: zhangyueqingyun@foxmail.com
> - wechat: abcde-ovo-yz
> 
> ğŸ¼ å…¶ä»–
> ---
> 
> - ğŸ‹ [ä¸ªäººåšå®¢](https://zhangyueqingyun.tech)
> - ğŸ’ [ç®—æ³•æµ‹è¯•æ¡†æ¶](https://github.com/zhangyueqingyun/algorithm)
> - ğŸ“ [å‰ç«¯åŸåˆ›èµ„æº](https://github.com/zhangyueqingyun/blog-resources)
