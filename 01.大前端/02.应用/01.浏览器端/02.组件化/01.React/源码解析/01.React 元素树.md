# React å…ƒç´ æ ‘

ğŸ˜† Hiï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¼ ç¥å¿äº‘ï¼Œä¸€ä¸ªé¢å‘æœªæ¥ç¼–ç¨‹çš„ç¨‹åºå‘˜ï¼å‡†å¤‡å°† React æºç è§£æå†™æˆä¸€ç³»åˆ—æ–‡ç« åˆ†äº«ç»™å¤§å®¶ï¼Œå¸Œæœ›å¤§å®¶å–œæ¬¢~ 

##  ä¸€ã€å‰è¨€

ä¸€ä¸ªæœ€ç®€å•çš„ React ç¨‹åºå¾€å¾€åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š

åˆ›å»º React å…ƒç´ æ ‘ï¼š

```javascript 
const element = React.createElement("div", {}, '');
```

åˆ›å»º FiberRoot èŠ‚ç‚¹å¹¶æŒ‚è½½åˆ° DOM å®¹å™¨èŠ‚ç‚¹ä¸Šï¼š

```javascript
const root = ReactDOM.createRoot(container);
```

FiberRoot æ¸²æŸ“ç¬¬ä¸€æ­¥åˆ›å»ºçš„ React å…ƒç´ æ ‘ï¼š

```javascript
root.render(element);
```

ä»Šå¤©æˆ‘ä»¬è¯¦ç»†è®²è§£çš„æ˜¯ React å…ƒç´ æ ‘çš„åˆ›å»ºã€‚

## äºŒã€React å…ƒç´ æ ‘

React å…ƒç´ æ ‘æ˜¯å¼€å‘è€…å’Œ React äº¤äº’çš„æ¡¥æ¢ï¼Œå…ƒç´ æ ‘æè¿°äº†ç›®æ ‡ç½‘ç«™çš„å…¨è²Œï¼Œ React ä¼šè§£æå…ƒç´ æ ‘ï¼Œè½¬åŒ–ä¸ºFiber æ¶æ„ï¼Œç”Ÿæˆäº¤äº’å¼çš„ç½‘é¡µã€‚

React å…ƒç´ æ ‘ç”± React å…ƒç´ æ„æˆï¼ŒReact å…ƒç´ æ˜¯ $$typeof å±æ€§ä¸º REACT_ELEMENT_TYPE çš„å¯¹è±¡ï¼Œå®ƒç”± ReactElement å·¥å‚å‡½æ•°åˆ›å»ºã€‚å®ƒè¿˜å…·æœ‰ typeï¼Œkeyï¼Œrefï¼Œprops å››ä¸ªåŸºæœ¬å±æ€§ï¼š

| å±æ€§ | ä»‹ç» |
| ---- | ---- |
| type | å…ƒç´ çš„ç±»å‹, å¯ä»¥ä¸º HTML å…ƒç´ æˆ– React ç»„ä»¶ |
| key | å…ƒç´ åœ¨å…¶åŒçº§å…„å¼Ÿä¸­çš„çš„èº«ä»½æ ‡å¿—ï¼ˆå”¯ä¸€é”®å€¼ï¼‰ |
| ref | å¯¹ç»„ä»¶å®ä¾‹çš„å¼•ç”¨ |
| props | ç»„ä»¶æˆ– HTML å…ƒç´ çš„å±æ€§å€¼ |

React å…ƒç´ è¿˜å…·æœ‰ \_owner, \_store, \_self, \_source ä¸‰ä¸ªå†…éƒ¨å±æ€§ï¼Œå…¶ä¸­ \_owner å±æ€§è®°å½•äº†åˆ›å»ºè¯¥å…ƒç´ çš„èµ·å› ï¼Œè€Œ \_store, \_self å’Œ \_source åœ¨å¼€å‘æ¨¡å¼ä¸‹æ‰ä¼šè¢«åˆ›å»ºã€‚

ä¸‹é¢æ˜¯ ReactElement å·¥å‚å‡½æ•°çš„æºç ï¼š

```javascript
/** åˆ›å»º React å…ƒç´ çš„å·¥å‚å‡½æ•° */
const ReactElement = function(type, key, ref, self, source, owner, props) {
    const element = {
        /** æ ‡è¯†è¯¥å¯¹è±¡ä¸º React å…ƒç´  */
        $$typeof: REACT_ELEMENT_TYPEï¼Œ
        type: type,
        key: key,
        ref: ref,
        props: props,
        _owner: owner
    }

    /** ... æ­¤å¤„çœç•¥ DEV æ¨¡å¼ä¸‹çš„è‹¥å¹²è¡Œä»£ç  ... */

    return element;
} 
```

## ä¸‰ã€React å…ƒç´ çš„åˆ›å»º

React.createElement å’Œ React.cloneElement æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„å¯ä»¥è·å– React å…ƒç´ çš„ Apiï¼š
```javascript
/** åˆ›å»ºä¸€ä¸ª React å…ƒç´  */
React.createElement(<MyElement />, {elementProp: 'element-prop'}, children);

/** å…‹éš†ä¸€ä¸ª React å…ƒç´  */
React.cloneElement(element, {newProp: 'new-prop'});
```

ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹è¿™ä¸¤ä¸ª Api çš„æºç ã€‚

### 3.1 React.createElement

React.createElement æ˜¯æœ€å¸¸è§çš„åˆ›å»º React å…ƒç´ çš„ Apiï¼Œå®ƒçš„æ‰§è¡Œæµç¨‹æ˜¯ï¼š

1. è§£æå½¢å‚ config è·å–å˜é‡ refã€keyã€selfã€ sourceã€ props å’Œ props.childrenã€‚
2. æ ¹æ® defaultProps åˆå§‹åŒ–å˜é‡ propsã€‚
3. åˆ©ç”¨ 1 ä¸­å˜é‡å’Œ ReactElement å·¥å‚å‡½æ•°åˆ›å»º React å…ƒç´ ã€‚

æºä»£ç å¦‚ä¸‹ï¼š

```javascript 
export function createElement(type, config, children) {
    let propName;

    const props = {};

    let key = null;
    let ref = null;
    let self = null;
    let source = null;

    if(config != null) {
        /** åˆå§‹åŒ– ref  */
        if(hasValidRef(config)) {
            ref = config.ref;
        }

        /** åˆå§‹åŒ– key */
        if(hasValidKey(config)) {
            key = '' + config.key;
        }
    }

    /** åˆå§‹åŒ– self å’Œ source  */
    self = config.__self === undefined ? null : config.__self;
    source = config.__source === undefined ? null : config.__source; 

    /** åˆå§‹åŒ–å…¶ä»– props */
    for (propName in config) {
        if (
            hasOwnProperty.call(config, propName) && 
            !RESERVED_PROPS.hasOwnProperty(propName)
        ) {
            props[propName] = config[propName];
        }
    }

    /** åˆå§‹åŒ– children */
    const childrenLength = arguments.length - 2;
    if(childrenLength === 1) {
        props.children = children;
    } else if (childrenLength > 1) {
        const childrenArray = Array(childrenLength);
        for(let i = 0; i < childrenLength; i++) {
            childrenArray = Array(childrenLength);
        }
        props.children = childrenArray;
    }

    /** åˆå§‹åŒ– defaultProps */
    if(type && type.defaultProps) {
        const defaultProps = type.defaultProps;
        for(propName in defaultProps) {
            if(props[Name] in defaultProps) {
                props[propName] = defaultProps[propName];
            }
        }
    }

    /** åˆ›å»º React å…ƒç´  */
    return ReactElement(
        type,
        key,
        ref,
        self,
        source,
        ReactCurrentOwner.current,
        props
    )
}
```

### 3.2 React.cloneElement 

React.cloneElement å’Œ React.createElement æ¯”è¾ƒç›¸ä¼¼ï¼Œæˆ‘ä»¬ç»å¸¸ç”¨å®ƒæ¥æ‰©å±•å·²å­˜åœ¨çš„ React å…ƒç´ çš„åŠŸèƒ½ï¼Œè¿™ä¸ª api ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š

1. ä»åŸ React å…ƒç´ ä¸­è·å– propsã€keyã€refã€\_selfã€\_sourceã€\_owner å±æ€§ã€‚
2. è§£ææ–°é…ç½®ï¼Œè·å–æ–°çš„ refã€keyã€defaultProps ç­‰å±æ€§å¹¶è¦†ç›–åŸå±æ€§ã€‚
3. æ ¹æ® defaultProps å’Œ props è®¾ç½®é»˜è®¤å€¼ã€‚
4. è·å– props.childrenã€‚
5. é€šè¿‡å·¥å‚å‡½æ•° ReactElement åˆ›å»º React å…ƒç´ å¹¶è¿”å›ã€‚

æºä»£ç å¦‚ä¸‹ï¼š

```javascript
export function cloneElement(element, config, children) {
    if(element === null || element === undefined) {
        throw new Error(`React.cloneElement(...): The argument must be a React element, but you passed ${element}`)
    }   

    let propName;

    // è·å–å¾…å…‹éš†å¯¹è±¡çš„ props
    const props = assign({}, element.props);

    /** è·å–å¾…å…‹éš†å¯¹è±¡çš„ key  */

    let key = element.key;
    /** è·å–å¾…å…‹éš†å¯¹è±¡çš„ ref*/
    let ref = element.ref;

    /** è·å–å¾…å…‹éš†å¯¹è±¡çš„ _selfã€ _sourceã€_owner å±æ€§ */
    const self = element._self;
    const source = element._source;
    let onwer = element._owner;

    /** è§£ææ–°çš„é…ç½® */
    if(config != null)  {

        /** è·å–æ–°çš„  ref */
        if(hasValidRef(config)) {
            ref = config.ref;
            owner = ReactCurrentOwner.current;
        }

        /** è·å–æ–°çš„ key  */
        if(hasValidKey(config)) {
            key = '' + config.key;
        }

        /** è·å– defaultProps  */
        let defaultProps;
        if(element.type && element.type.defaultProps) {
            defaultProps = element.type.defaultProps;
        }

        /** æ ¹æ®æ–°çš„ defaultProps å’Œä»è¢«å…‹éš†å…ƒç´ è·å–çš„ props åˆå§‹åŒ– props */
        for(propName in config) {
            if(
                hasOwnProperty.call(config, propName) && 
                !RESERVED_PROPS.hasOwnProperty(propName)
            ) {
                if(config[propName] === undefined && defaultProps !== undefined) {
                    props[propName] = defaultProps[propName];
                } else {
                    props[propName] = config[propName];
                }
            }
        }

        /** è·å– children */
        const childrenLength = arguments.length - 2;
        if(chidlrenLength === 1) {
            props.children = children;
        } else if (childrenLength > 1) {
            const childArray = Array(ChildrenLength);
            for(let i = 0; i < childrenLength; i++) {
                childArray[i] = arguments[i + 2];
            }

            props.children = childArray;
        }

        /** é€šè¿‡å·¥å‚å‡½æ•°åˆ›å»º React å…ƒç´ å¹¶è¿”å› */
        return ReactElement(element.type, key, ref, self, source, owner, props);
    }
}
```          

## å››ã€ç»“å°¾

è¿™äº›å°±æ˜¯ ReactElement å…ƒç´ æ ‘çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¦‚æœ‰ç–‘æƒ‘ï¼Œæ¬¢è¿å°ä¼™ä¼´ä»¬è”ç³»æˆ‘~ @V@ ~

æœ€åæ¥åˆ™å¹¿å‘Š @v@~

> âœ¨ å¸ƒçµå¸ƒçµï¼YQY ä½ä»£ç å¹³å°é¦–å‘å•¦ï¼
> ---
> 
> #### ğŸ“ åŸºæœ¬åŠŸèƒ½
> 
> - é€šè¿‡æ‹–æ‹½è‡ªåŠ¨ç”Ÿæˆ React é¡¹ç›®ä»£ç ï¼ˆåŒ…å«è·¯ç”±ã€å¸ƒå±€ã€é¡µé¢ã€ç»„ä»¶ã€cssæ ·å¼ï¼‰ã€‚
> - è‡ªåŠ¨åŒ–ç”Ÿæˆä»£ç ä»“åº“ã€‚
> - è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - å¿«æ·è®¿é—®éƒ¨ç½²çš„é¡¹ç›®ã€é¡µé¢ã€‚
> - é€šè¿‡ä½ä»£ç å¹³å°å¯¹å·²ç”Ÿæˆçš„é¡¹ç›®è¿›è¡Œä¿®æ”¹ã€‚
> - æ‹‰å–é¡¹ç›®è‡³æœ¬åœ°ï¼Œç”±å¼€å‘äººå‘˜æ‰‹åŠ¨å¼€å‘ï¼Œæ¨é€åˆ°è¿œç¨‹ä»“åº“åè‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - æ¥å…¥ä¸åŒç»„ä»¶åº“ã€‚
> - æ”¯æŒæ¥å…¥åŸ‹ç‚¹ã€ç›‘æ§ç­‰å‰ç«¯æ¶æ„ã€‚
> 
> #### ğŸ“ ä¼˜ç‚¹
> 
> - ç”Ÿæˆçš„ä»£ç å¯è¯»æ€§å¥½ï¼ŒåŒ…å«æ³¨é‡Šã€‚
> - å¯ç”Ÿæˆä¸åŒç±»å‹çš„ç»„ä»¶ï¼ˆå‡½æ•°ç»„ä»¶ã€ç±»ç»„ä»¶ï¼‰ã€‚
> - å¯è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®ã€å¸ƒå±€ã€é¡µé¢ã€è·¯ç”±ç­‰ã€‚
> - æ”¯æŒè‡ªåŠ¨åˆ›å»ºä»£ç ä»“åº“ã€è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - æ”¯æŒæ¥å…¥ä¸åŒç»„ä»¶åº“ã€‚
> - æ”¯æŒæ¥å…¥åŸ‹ç‚¹ã€ç›‘æ§ç­‰ä¼ä¸šçº§å‰ç«¯æ¶æ„ã€‚
> 
> ğŸ˜ˆ å¦‚æ„Ÿå…´è¶£ï¼Œå¯è”ç³»æœ¬äººï¼šå¼ ç¥å¿äº‘ 
> 
> - ç”µè¯: 16602927079 
> - é‚®ç®±: zhangyueqingyun@foxmail.com
> - å¾®ä¿¡: abcde-ovo-yz
> 
> ğŸ¼ å…¶ä»–
> ---
> 
> - ğŸ‹ [ä¸ªäººåšå®¢](https://zhangyueqingyun.tech)
> - ğŸ’ [ç®—æ³•æµ‹è¯•æ¡†æ¶](https://github.com/zhangyueqingyun/algorithm)
> - ğŸ“ [å‰ç«¯åŸåˆ›èµ„æº](https://github.com/zhangyueqingyun/blog-resources)
