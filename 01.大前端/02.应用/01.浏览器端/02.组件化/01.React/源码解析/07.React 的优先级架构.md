# React çš„ä¼˜å…ˆçº§æ¶æ„

ğŸ˜† Hiï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¼ ç¥å¿äº‘ï¼Œä¸€ä¸ªé¢å‘æœªæ¥ç¼–ç¨‹çš„ç¨‹åºå‘˜ï¼å‡†å¤‡å°† React æºç è§£æå†™æˆä¸€ç³»åˆ—æ–‡ç« åˆ†äº«ç»™å¤§å®¶ï¼Œå¸Œæœ›å¤§å®¶å–œæ¬¢~ 

## ä¸€ã€ å‰è¨€

å½“ç¬¬ä¸€æ¬¡ Fiber æ ‘åˆå§‹åŒ–å®Œæˆåï¼Œä¼šç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿäº§ç”Ÿå¯¹ Fiber æ ‘çš„æ›´æ–°ä»»åŠ¡ï¼Œreact ä¼šæ ¹æ®è¿™äº›æ›´æ–°ä»»åŠ¡æ›´æ–° Fiber æ ‘å¹¶æ¸²æŸ“åˆ°å½“å‰é¡µé¢ä¸Šã€‚

åœ¨è¿™ä¸ªæ›´æ–°æµç¨‹ä¸­ï¼Œå‡ºç°äº†å››ç§ä¸åŒçš„ä¼˜å…ˆçº§ï¼š

- äº‹ä»¶ä¼˜å…ˆçº§ï¼šæ ¹æ®æ´¾ç”Ÿäº‹ä»¶çš„ä¼˜å…ˆç¨‹åº¦åˆ’åˆ†çš„ä¼˜å…ˆçº§
- æ›´æ–°ä¼˜å…ˆçº§ï¼šæ›´æ–° fiber æ ‘çš„ä¼˜å…ˆçº§
- ä»»åŠ¡ä¼˜å…ˆçº§ï¼šæ‰§è¡Œæ›´æ–°ä»»åŠ¡çš„ä¼˜å…ˆçº§
- è°ƒåº¦ä¼˜å…ˆçº§ï¼šè°ƒåº¦ä¼˜å…ˆçº§

ä¸‹é¢æˆ‘ä»¬è¯¦ç»†ä»‹ç»å‡ ç§ä¼˜å…ˆçº§ã€‚

## äºŒã€äº‹ä»¶ä¼˜å…ˆçº§

React æŒ‰ç…§äº‹ä»¶çš„ç´§æ€¥ç¨‹åº¦å°†ä»–ä»¬åˆ’åˆ†ä¸º DiscreteEvent, UserBlockingEvent, ContinuousEventï¼ŒIdleEvent ç­‰ã€‚

- DiscreteEvent: ç¦»æ•£äº‹ä»¶ï¼ŒåŒ…æ‹¬ clickã€keydownã€focusin ç­‰ï¼Œè¿™äº›äº‹ä»¶çš„è§¦å‘ä¸æ˜¯è¿ç»­çš„ï¼Œä¼˜å…ˆçº§ä¸º 0 ï¼ˆcancle click close contextmenu copy cut auxclick dblclick dragend dragstart drop focusin focusout input invalid keydown keypress keyup mousedown mouseup paste pause play pointercancel pointerdown pointerup ratechange reset resize seeked submit touchcancel touchend touchstart volumechange change selectionchange textInput compositionstart compositionupdate beforeblur afterblur beforeinput blur fullscreenchange focus hashchange popstate select selectstartï¼‰

- UserBlockingEvent: ç”¨æˆ·é˜»å¡äº‹ä»¶ï¼ŒåŒ…æ‹¬ dragã€scrollã€mouseover ç­‰ï¼Œè¿ç»­è§¦å‘ã€é˜»å¡æ¸²æŸ“ï¼Œä¼˜å…ˆçº§ä¸º 1 (ç›®å‰å¤„ç†å’Œ ContinuouseEvent ç›¸åŒ)

- ContinuousEvent: è¿ç»­äº‹ä»¶ï¼ŒåŒ…æ‹¬ canplayã€errorã€audioæ ‡ç­¾çš„ timeupdate å’Œ canplayï¼Œä¼˜å…ˆçº§é«˜ï¼Œä¸º2 (drag dragenter dragexit dragleave dragover mousemove mouseout mouseover pointermove pointerout pointerover scroll toggle touchmove wheel mouseenter mouseleave pointerenter mouseleave pointerenter pointerleave)

- IdleEvent

## ä¸‰ã€æ›´æ–°ä¼˜å…ˆçº§

lane ä¼˜å…ˆçº§ï¼Œå¯¹åº” update æ›´æ–°å¯¹è±¡çš„ä¼˜å…ˆçº§ï¼Œä¹Ÿå¯¹åº” fiber çš„ä¼˜å…ˆçº§ã€‚

æ¯ä¸€ä¸ªäº‹ä»¶ä¼˜å…ˆçº§éƒ½ç­‰åŒäºä¸€ä¸ª lane ä¼˜å…ˆçº§

```javascript
export const DiscreteEventPriority = SyncLane;
export const ContinuousEventPriority = InputContinuousLane;
export const DefaultEventPriority = DefaultLane;
export const IdleEventPriority = IdleLane;
```

```javascript
export const TotalLanes = 31;
export const NoLanes;
export const SyncLane;
export const InputContinuousHydrationLane;
export const InputContinuousLane;
export const DefaultHydrationLane;
export const DefaultLane;

const TransitionHydrationLane;
const TransitionLanes;
const TransitionLanes1;
const TransitionLanes2;
const TransitionLanes3;
const TransitionLanes4;
const TransitionLanes5;
const TransitionLanes6;
const TransitionLanes7;
const TransitionLanes8;
const TransitionLanes9;
const TransitionLanes10;
const TransitionLanes11;
const TransitionLanes12;
const TransitionLanes13;
const TransitionLanes14;
const TransitionLanes15;
const TransitionLanes16;

const RetryLanes;
const RetryLanes1;
const RetryLanes2;
const RetryLanes3;
const RetryLanes4;
const RetryLanes5;

export const SomeRetryLane;
export const SelectiveHydrationLane;

const NonIdleLanes;

export const IdleHydrationLane;
export const IdleLane;
export const OffscreenLane;
```

## å››ã€è°ƒåº¦ä¼˜å…ˆçº§


scheduler åŒ…ï¼š
```javascript
export const NoPriority = 0;
export const ImmediatePriority = 1;
export const UserBlockingPriority = 2;
export const NormalPriority = 3;
export const LowPriority = 4;
export const IdlePriority = 5;

export {
    ImmediatePriority as unstable_ImmediatePriority,
    UserBlockingPriority as unstable_UserBlockingPriority,
    NormalPriority as unstable_NormalPriority,
    IdlePriority as unstable_IdlePriority,
    LowPriority as unstable_LowPriority
}
```

reconciler - Scheduler

```javascript
export const ImmediatePriority = Scheduler.unstable_ImmediatePriority;
export const UserBlockingPriority = Scheduler.unstable_UserBlockingPriority;
export const NormalPriority = Scheduler.unstable_NormalPriority;
export const LowPriority = Scheduler.unstable_LowPriority;
export const IdlePriority = Scheduler.unstable_IdlePriority;
```

## äº”ã€LanePriorityã€SchedulerPriorityã€ReactPriorityLevel ç›¸äº’è½¬æ¢

### 5.1 SchedulerPriority å’Œ ReactPriorityLevel è½¬æ¢

```javascript
    // å°† SchedulerPriority è½¬æ¢ä¸º ReactPriorityLevel
    export function getCurrentPriorityLevel() {
        switch(Scheduler_getCurrentPriorityLevel()) {
            case Scheduler_ImmediatePriority:
                return ImmediatePriority;
            case Scheduler_UserBlockingPriority:
                return UserBlockingPriority;
            case Scheduler_NormalPriority:
                return NormalPriority;
            case Scheduler_LowPriority:
                return LowPriority;
            case Scheduler_IdlePriority:
                return IdlePriority;
            default:
                invariant(false, 'Unknown prioritiy');    
        }
    }

    // å°† ReactPriorityLevel è½¬æ¢æˆ SchedulerPriority
    function reactPriorityToSchedulerPriority(reactPriorityLevel) {
        switch (reactPriorityLevel) {
            case ImmediatePriority:
                return Scheduler_ImmediatePriority;
            case UserBlockingPriority:
                return Scheduler_UserBlockingPriority;
            case NormalPriority:
                return Scheduler_NormalPriority;
            case LowPriority:
                return Scheduler_LowPriority;
            case IdlePriority:
                return Scheduler_IdlePriority;
            default:
                invariant(false, 'Unknown priority level.');
        }
    }

    export function schedulerPriorityToLanePriority (schedulerPriorityLevel) {
        switch(lanePriority) {
            case ImmediateSchedulerPriority:
                return SyncLanePriority;
            default:
                return NoLanePriority;
        }
    }

    export function lanePriorityToSchedulerPriority(lanePriority) {
        switch(lanePriority) {
            case SyncLanePriority:
            case SyncBatchedLanePriority:
                return ImmediateSchedulerPriority;
            default:
                invariate(
                    false,
                    'Invalid update priority: %s. This is a bug in React.',
                    lanePriority
                )
        }
    }
```