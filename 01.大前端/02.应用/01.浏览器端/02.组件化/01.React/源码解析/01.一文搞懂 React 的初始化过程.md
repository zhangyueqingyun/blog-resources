# ä¸€æ–‡ææ‡‚ React çš„åˆå§‹åŒ–è¿‡ç¨‹

ğŸ˜† Hiï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¼ ç¥å¿äº‘ï¼Œä¸€ä¸ªé¢å‘æœªæ¥ç¼–ç¨‹çš„ç¨‹åºå‘˜ï¼ä¸‹é¢å°†è¦å›´ç»•æºç è®²è§£ React çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¸Œæœ›å¤§å®¶å–œæ¬¢ ~

##  ä¸€ã€æ¦‚è§ˆ

æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªæœ€ç®€å•çš„ React ç¨‹åºå¾€å¾€åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š

1. åˆ›å»º React å…ƒç´ æ ‘ã€‚
2. åˆ›å»º FiberRoot èŠ‚ç‚¹å¹¶æŒ‚è½½åˆ° DOM å®¹å™¨èŠ‚ç‚¹ä¸Šã€‚
3. FiberRoot æ¸²æŸ“ç¬¬ä¸€æ­¥åˆ›å»ºçš„ React å…ƒç´ æ ‘ã€‚

å¯¹åº”ä»¥ä¸‹è¡Œä»£ç ï¼š
 
```javascript
/** åˆ›å»º React å…ƒç´ æ ‘ */
const element = React.createElement('div', {}, '');

/** åˆ›å»º FiberRoot èŠ‚ç‚¹å¹¶æŒ‚åœ¨åˆ° DOM å®¹å™¨ä¸Š */
const root = ReactDOM.createRoot(container);

/** ç”± Fiber Root æ¸²æŸ“å…ƒç´ æ ‘ */
root.render(element);
```

ä»Šå¤©æˆ‘ä»¬è¦è®²çš„ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªæ­¥éª¤ï¼Œåˆ›å»º React å…ƒç´ æ ‘å’Œåˆ›å»ºå¹¶æŒ‚è½½ FiberRoot èŠ‚ç‚¹ã€‚   

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œä»€ä¹ˆæ˜¯ React å…ƒç´ ã€‚

## äºŒã€React å…ƒç´  

### 2.1 ä¸€å¥è¯ç†è§£ React å…ƒç´ 

React å…ƒç´ æ ‘æ˜¯ React ä½¿ç”¨è€…å’Œ React äº¤äº’çš„æ¡¥æ¢ï¼Œæˆ‘ä»¬ç”¨å®ƒæ¥å‘Šè¯‰ React æˆ‘ä»¬æƒ³è¦çš„ç½‘ç«™æ˜¯ä»€ä¹ˆæ ·çš„ã€‚ React ä¼šè§£ææˆ‘ä»¬å®šä¹‰çš„å…ƒç´ æ ‘ï¼Œå¹¶åœ¨åœ¨å†…éƒ¨è½¬åŒ–ä¸ºè‡ªå·±çš„æ•°æ®ç»“æ„ï¼ˆFiber æ¶æ„ï¼‰ï¼Œç”Ÿæˆäº¤äº’ç½‘ç«™ã€‚

### 2.2 æºç è§£æ

åœ¨æºç ä¸­ï¼ŒReact å…ƒç´ æ˜¯ä¸€ä¸ªå«æœ‰ $$typeof å±æ€§çš„å¯¹è±¡ï¼Œç”±ä¸€ä¸ªåä¸º ReactElement çš„å·¥å‚å‡½æ•°åˆ›å»ºã€‚React é€šè¿‡åˆ¤æ–­ $$typeof æ˜¯å¦ç­‰äº REACT_ELEMENT_TYPE è€Œç¡®å®šè¯¥å¯¹è±¡æ˜¯å¦ä¸º React å…ƒç´ ã€‚  

React å…ƒç´ å…·æœ‰ typeï¼Œkeyï¼Œrefï¼Œprops å››ä¸ªåŸºæœ¬å±æ€§ï¼Œæˆ‘ä»¬ç®€å•çœ‹ä¸‹è¿™å››ä¸ªåŸºæœ¬å±æ€§ï¼š

- type æ˜¯ React å…ƒç´ çš„ç±»å‹ï¼Œhtml å…ƒç´ åï¼Œä¹Ÿå¯ä»¥ä¸ºæˆ‘ä»¬å®šä¹‰çš„ React ç»„ä»¶ã€‚
- key æ˜¯ React å…ƒç´ åœ¨å…¶åŒçº§å…„å¼Ÿä¸­çš„çš„èº«ä»½æ ‡å¿—ï¼Œæ›´æ–° Fiber æ ‘çš„æ—¶å€™ä¼šç”¨å®ƒæ¥ç¡®å®š React å…ƒç´ çš„èº«ä»½ï¼ŒReact ç”¨å®ƒæé«˜ Fiber æ ‘çš„æ›´æ–°æ€§èƒ½ã€‚
- ref æ˜¯å¯¹ç»„ä»¶å®ä¾‹çš„å¼•ç”¨ã€‚
- props æ˜¯ React æˆ– DOM ç»„ä»¶ä¼ é€’çš„å±æ€§å€¼ã€‚

React åŒæ—¶ä¹Ÿå…·æœ‰ \_owner, \_store, \_self, \_source ä¸‰ä¸ªå†…éƒ¨å±æ€§ã€‚\_owner å±æ€§è®°å½•äº†åˆ›å»ºè¯¥å…ƒç´ çš„èµ·å› ï¼Œè€Œ \_store, \_self å’Œ \_source åœ¨å¼€å‘æ¨¡å¼ä¸‹æ‰ä¼šè¢«åˆ›å»ºï¼Œæœ¬æ–‡ä¸è¿‡å¤šè®²è§£äº†ã€‚

```javascript
/** åˆ›å»º React å…ƒç´ çš„å·¥å‚å‡½æ•° */
const ReactElement = function(type, key, ref, self, source, owner, props) {
	const element = {
		/** æ ‡è¯†è¯¥å¯¹è±¡ä¸º React å…ƒç´  */
		$$typeof: REACT_ELEMENT_TYPEï¼Œ
		type: type,
		key: key,
		ref: ref,
		props: props,
		_owner: owner
	}

	/** ... æ­¤å¤„çœç•¥ DEV æ¨¡å¼ä¸‹çš„è‹¥å¹²è¡Œä»£ç  ... */

	return element;
} 
```

## ä¸‰ã€React å…ƒç´ çš„åˆ›å»º

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ª React æä¾›çš„ Api åˆ›å»º React å…ƒç´ ï¼š 

- React.createElement
- jsx
- React.cloneElement
- React.cloneAndReplaceKey 

æœ¬æ–‡æˆ‘ä»¬åªåˆ†æ React.createElement å’Œ React.cloneElement çš„æºç ã€‚

### 3.1 React.createElement

React.createElement æ˜¯ React åˆ›å»º React å…ƒç´ æœ€åŸºæœ¬çš„æ–¹æ³•ï¼Œå®ƒä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š

1. é€šè¿‡ config å½¢å‚è·å– refã€keyã€selfã€ sourceã€ props å’Œ props.childrenã€‚
2. æ ¹æ® defaultProps åˆå§‹åŒ– propsã€‚
3. é€šè¿‡å·¥å‚å‡½æ•° ReactElement åˆ›å»º React å…ƒç´ ã€‚

```javascript 
export function createElement(type, config, children) {
	let propName;

	const props = {};

	let key = null;
	let ref = null;
	let self = null;
	let source = null;

	if(config != null) {

		/** åˆå§‹åŒ– ref  */
		if(hasValidRef(config)) {
			ref = config.ref;
		}

		/** åˆå§‹åŒ– key */
		if(hasValidKey(config)) {
			key = '' + config.key;
		}
	}

    /** åˆå§‹åŒ– self å’Œ source  */
	self = config.__self === undefined ? null : config.__self;
	source = config.__source === undefined ? null : config.__source; 

	/** åˆå§‹åŒ–å…¶ä»– props */
	for (propName in config) {
		if (
			hasOwnProperty.call(config, propName) && 
			!RESERVED_PROPS.hasOwnProperty(propName)
		) {
			props[propName] = config[propName];
		}
	}

	/** åˆå§‹åŒ– children */
	const childrenLength = arguments.length - 2;
	if(childrenLength === 1) {
		props.children = children;
	} else if (childrenLength > 1) {
		const childrenArray = Array(childrenLength);
		for(let i = 0; i < childrenLength; i++) {
			childrenArray = Array(childrenLength);
		}
		props.children = childrenArray;
	}

	/** åˆå§‹åŒ– defaultProps */
	if(type && type.defaultProps) {
		const defaultProps = type.defaultProps;
		for(propName in defaultProps) {
			if(props[Name] in defaultProps) {
				props[propName] = defaultProps[propName];
			}
		}
	}

	/** åˆ›å»º React å…ƒç´  */
	return ReactElement(
		type,
		key,
		ref,
		self,
		source,
		ReactCurrentOwner.current,
		props
	)
}
```

### 3.2 React.cloneElement 

React.cloneElement å’Œ React.createElement æ¯”è¾ƒç›¸ä¼¼ï¼Œæˆ‘ä»¬ç»å¸¸ç”¨å®ƒæ¥æ‰©å±•å·²å­˜åœ¨çš„ React å…ƒç´ çš„åŠŸèƒ½ï¼Œè¿™ä¸ª api ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š

1. ä»åŸ React å…ƒç´ ä¸­è·å– propsã€keyã€refã€\_selfã€\_sourceã€\_owner å±æ€§ã€‚
2. è§£ææ–°é…ç½®ï¼Œè·å–æ–°çš„ refã€keyã€defaultProps ç­‰å±æ€§å¹¶è¦†ç›–åŸå±æ€§ã€‚
3. æ ¹æ® defaultProps å’Œ props è®¾ç½®é»˜è®¤å€¼ã€‚
4. è·å– props.childrenã€‚
5. é€šè¿‡å·¥å‚å‡½æ•° ReactElement åˆ›å»º React å…ƒç´ å¹¶è¿”å›ã€‚

```javascript
export function cloneElement(element, config, children) {
	if(element === null || element === undefined) {
		throw new Error(`React.cloneElement(...): The argument must be a React element, but you passed ${element}`)
	}   

	let propName;

	// è·å–å¾…å…‹éš†å¯¹è±¡çš„ props
	const props = assign({}, element.props);

	/** è·å–å¾…å…‹éš†å¯¹è±¡çš„ key  */

	let key = element.key;
	/** è·å–å¾…å…‹éš†å¯¹è±¡çš„ ref*/
	let ref = element.ref;

	/** è·å–å¾…å…‹éš†å¯¹è±¡çš„ _selfã€ _sourceã€_owner å±æ€§ */
	const self = element._self;
	const source = element._source;
	let onwer = element._owner;

	/** è§£ææ–°çš„é…ç½® */
	if(config != null)  {

		/** è·å–æ–°çš„  ref */
		if(hasValidRef(config)) {
			ref = config.ref;
			owner = ReactCurrentOwner.current;
		}

		/** è·å–æ–°çš„ key  */
		if(hasValidKey(config)) {
			key = '' + config.key;
		}

		/** è·å– defaultProps  */
		let defaultProps;
		if(element.type && element.type.defaultProps) {
			defaultProps = element.type.defaultProps;
		}

		/** æ ¹æ®æ–°çš„ defaultProps å’Œä»è¢«å…‹éš†å…ƒç´ è·å–çš„ props åˆå§‹åŒ– props */
		for(propName in config) {
			if(
				hasOwnProperty.call(config, propName) && 
				!RESERVED_PROPS.hasOwnProperty(propName)
			) {
				if(config[propName] === undefined && defaultProps !== undefined) {
					props[propName] = defaultProps[propName];
				} else {
					props[propName] = config[propName];
				}
			}
		}

		/** è·å– children */
		const childrenLength = arguments.length - 2;
		if(chidlrenLength === 1) {
			props.children = children;
		} else if (childrenLength > 1) {
			const childArray = Array(ChildrenLength);
			for(let i = 0; i < childrenLength; i++) {
				childArray[i] = arguments[i + 2];
			}

			props.children = childArray;
		}

		/** é€šè¿‡å·¥å‚å‡½æ•°åˆ›å»º React å…ƒç´ å¹¶è¿”å› */
		return ReactElement(element.type, key, ref, self, source, owner, props);
	}
}
```

## å››ã€åˆ›å»ºå¹¶æŒ‚è½½ FiberRoot                                               

React é€šè¿‡åˆ›å»º FiberRoot å¹¶å°†å…¶æŒ‚è½½åˆ° DOM å®¹å™¨å…ƒç´ ä¸Šæ¥åˆå§‹åŒ–å®ƒçš„å·¥ä½œç¯å¢ƒï¼Œå¯¹åº”çš„ Api ä¸º React.createRoot ã€‚

### 4.1 React.createRoot                                                                                                                                    

React.createRoot æ˜¯åˆ›å»ºå’ŒæŒ‚è½½ FiberRoot çš„æ€»æ§å‡½æ•°ï¼Œå®ƒçš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. å¤„ç† options ä¸­ä¸€äº›å¯é…ç½®çš„å±æ€§
2. åˆ›å»º FiberRoot 
3. å°† FiberRoot æŒ‚è½½åˆ°äº† DOM å®¹å™¨èŠ‚ç‚¹ä¸Š
4. åˆå§‹åŒ– Dispatcher
5. è·å–å¹¶ç›‘å¬è¯¥ç›‘å¬çš„ DOM å®¹å™¨èŠ‚ç‚¹çš„æ‰€æœ‰äº‹ä»¶
6. è¿”å› ReactDOMRoot

```javascript
export function createRoot(
	container,
	options
) {
	if(!isValidContainer(container)) {
		throw new Error('createRoot(...): Target container is not a DOM element');
	}

	let isStrictMode = false;    // ä¸¥æ ¼æ¨¡å¼
	let concurrentUpdatesByDefaultOverride = false;    // è®¾ç½®æ›´æ–°æ¨¡å¼
	let identifierPrefix = '';    //  å‰ç¼€
	let onRecoverableError = defaultOnRecoverableError;  // å¯æ¢å¤çš„é”™è¯¯å¤„ç†æ–¹æ³•
	let transitionCallbacks = null;    // è¿‡åº¦å›è°ƒ

	if(options !== null && options !== undefined) {
		/** è®¾ç½®ä¸¥æ ¼æ¨¡å¼ */
		if(options.unstable_strictMode === true) {
			isStrictMode = true;
		}

		/** è®¾ç½® ConcurrentUpdatesByDefaultMode ä¸º true  */ 
		if(
			allowConcurrentByDefault &&
			options.unstable_concurrentUpdatesByDefault === true
		) {
			concurrentUpdatesByDefaultOverride = true;
		}

		/** è®¾ç½®å‰ç¼€ */
		if(options.identifierPrefix !== undefined) {
			identifierPrefix = options..identifierPrefix;
		}

		/** è®¾ç½®å¯æ¢å¤çš„é”™è¯¯å¤„ç†å›è°ƒ */
		if(options.onRecoverableError !== undefined) {
			onRecoverableError = options.onRecoverableError;
		}

		/** è®¾ç½®è¿‡æ¸¡å›è°ƒ */
		if(options.unstable_transitionCallbacks !== undefined) {
			transitionCallbacks = options.unstable_transitionCallbacks;
		}
	}

	/** åˆ›å»º FiberRoot */
	const root = createContainer(
		container,
		ConcurrentRoot,
		null,
		isStrictMode,
		concurrentUpdatesByDefaultOverride,
		identifierPrefix,
		onRecoverableError,
		transitionCallbacks
	);

	/** å°† FiberRoot æŒ‚è½½åˆ° DOM èŠ‚ç‚¹ä¸Š */
	markContainerAsRoot(root.current, container);

	/** åˆå§‹åŒ– Dispatcher */
	if(enableFloat) {
		Dispatcher.current = ReactDOMClientDispatcher;
	}

	/** è·å–æ ¹å…ƒç´ èŠ‚ç‚¹ */
	const rootContainerElement = container.nodeType = COMMENT_NODE ? container.parentNode : container;

	/** ç›‘å¬æ ¹å…ƒç´ èŠ‚ç‚¹çš„æ‰€æœ‰äº‹ä»¶ */
	listenToAllSupportedEvents(rootContainerElement);

	/** è¿”å› ReactDOMRoot */
	return new ReactDOMRoot(root);
}
```

#### 4.1.1 FiberRoot çš„åˆ›å»º

##### 4.1.1.1 FiberRootNode

FiberRootNode æ˜¯ FiberRoot çš„ç±»æ„é€ å‡½æ•°ï¼Œå®ƒå®šä¹‰äº† FiberRoot æ‰€æ‹¥æœ‰çš„å±æ€§ï¼Œè¿™äº›å±æ€§è¯¦ç»†çš„æ„ä¹‰å°†åœ¨ Fiber æ¶æ„çš„æ‰§è¡Œæœºåˆ¶å½¼ç¯‡è®²è§£ï¼Œå¤§å®¶å…ˆç®€å•çœ‹ä¸€ä¸‹å®ƒçš„ä»£ç ã€‚

```javascript
function FiberRootNode(
	containerInfo,
	tag,
	hydrate,
	identifierPrefix,
	onRecoverableError
) {
	this.tag = tag;
	this.containerInfo = containerInfo;    // DOM å®¹å™¨èŠ‚ç‚¹
	this.pendingChildren = null;    
	this.current = null;    // Fiber æ ‘
	this.pingCache = null;
	this.finishedWork = null;    
	this.timeoutHandle = noTimeout;
	this.context = null;
	this.pendingContext = null;
	this.callbackNode = null;
	this.callbackPriority = NoLane;
	this.eventTimes = createLaneMap(NoLanes);

	this.pendingLanes = NoLanes;
	this.suspencedLanes = NoLanes;
	this.pingedLanes = NoLanes;
	this.expiredLanes = NoLanes;
	this.mutableReadLanes = NoLanes;

	this.entangledLanes = NoLanes;
	this.hiddenUpdates = createLaneMap(null);

	this.identifierPrefix = identifierPrefix;
	this.onRecoverableError = onRecoverableError;

	if(enableCache) {
		this.pooledCache = null;
		this.pooledCacheLanes = NoLanes;
	}

	if(supportsHydration) {
		this.mutableSourceEagerHydrationData = null;
	}

	if(enableSuspenseCallback) {
		this.hydrationCallbacks = null;
	}

	this.incompleteTransitions = new Map();
	if(enableTransitionTracking) {
		this.transitionCallbacks = null;
		const transitionLanesMap = (this.transitionLanes = []);
		for(let i = 0; i < TotalLanes; i++) {
			pendingUpdatersLaneMap.push(new Set())
		}
	}
}
```

çœ‹å®Œäº† FiberRootNode ç±»å‡½æ•°ï¼Œæˆ‘ä»¬çœ‹çœ‹ FiberRoot çš„åˆ›å»ºå‡½æ•° createContainer å’Œ createFiberRootã€‚

##### 4.1.1.2 createContainer

createContainer å‡½æ•°ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š

1. è®¾ç½® hydrate å’Œ initialChildren ä¸¤ä¸ªå±æ€§
2. è°ƒç”¨ createFiberRoot å‡½æ•°åˆ›å»º FiberRoot 

hydrate æ˜¯æœåŠ¡ç«¯æ¸²æŸ“æ³¨æ°´æ“ä½œçš„æ ‡å¿—ï¼Œè¢«è®¾ç½®ä¸º falseï¼ŒinitialChildren æ˜¯åˆå§‹åŒ–çš„å­èŠ‚ç‚¹ï¼Œè¢«è®¾ç½®ä¸º null ã€‚

```javascript
export function createContainer(
	containerInfo,
	tag,
	hydrationCallbacks,
	isStrictMode,
	concurrentUpdatesByDefaultOverride,
	identifierPrefix,
	onRecoverableError,
	transitionCallbacks
) {
	const hydrate = false;    // æœåŠ¡æ®µæ¸²æŸ“ç›¸å…³
	const initialChildren = null;    // åˆå§‹å­èŠ‚ç‚¹

	return createFiberRoot(
		containerInfo,
		tag,
		hydrate,
		initialChildren,
		hydrationCallbacks,
		isStrictMode,
		concurrentUpdatesByDefaultOverride,
		identifierPrefix,
		onRecoverableError,
		transitionCallbacks
	)
}
```          

##### 4.1.1.3 createFiberRoot

createFiberRoot åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼šçš„æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºäº† FiberRoot å’Œ HostRootFiber å¹¶ä¸º FiberRoot å’Œ HostRootFiber åšäº†ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œå…·ä½“å¦‚ä¸‹ï¼š

1. åˆ›å»º FiberRoot
2. ä¸º FiberRoot è®¾ç½® hydrationCallbacks å’Œ transitionCallbacks
3. åˆ›å»º HostRootFiber
4. å°† FiberRoot.current è®¾ç½®ä¸º HostRootFiber
5. å°† HostRootFiber çš„ stateNode è®¾ç½®ä¸º FiberRoot
6. åˆå§‹åŒ– HostRootFiber çš„æ›´ä¿®é˜Ÿåˆ—

åœ¨ createFiberRoot çš„æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºäº† HostRootFiberï¼Œå¹¶å°† FiberRoot çš„ current å±æ€§è®¾ç½®ä¸º HostRootFiberã€å°† HostRootFiber çš„ stateNode å±æ€§è®¾ç½®ä¸º FiberRoot ã€‚ ç°åœ¨çš„ HostRooterFiber å¯¹åº”çš„å°±æ˜¯æœªåˆå§‹åŒ–çš„ Fiber æ ‘ï¼Œè¿™äº›å†…å®¹åœ¨ Fiber æ¶æ„ä¸­ä¼šè®²åˆ°ã€‚

``` javascript
export function createFiberRoot(
	containerInfo,
	tag,
	hydrate,
	initialChildren,
	hydrationCallbacks,
	isStrictMode,
	concurrentUpdatesByDefaultOverride,
	identifierPrefix,
	onRecoverableError,
	transitionCallbacks
) {

	/** åˆ›å»º FiberRoot */
	const root = new FiberRootNode(
		containerInfo,
		tag,
		hydrate,
		identifierPrefix,
		onRecoverableError
	);

	/** è®¾ç½®æœåŠ¡ç«¯æ¸²æŸ“å›è°ƒ */
	if(enableSuspenseCallback)  {
		root.hydrationCallbacks = hydrationCallbacks;
	}

	/** è®¾ç½®è¿‡æ¸¡å›è°ƒ */
	if(enableTransitionTracing) {
		root.transitionCallbacks = transitionCallbacks;
	}

	/** åˆ›å»º HostRootFiber */
	const uninitializedFiber = createHostRootFiber(
		tag,
		isStrictMode,
		concurrentUpdatesByDefaultOverride
	);

	/** å°† HostRootFiber æŒ‚è½½åˆ° FiberRoot çš„ current å±æ€§ä¸Š */
	root.current = uninitializedFiber;

	/** å°† HostRootFiber çš„ stateNode è®¾ç½®ä¸º FiberRoot */
	uninitializedFiber.stateNode = root;

	/** è®¾ç½® HostRootFiber çš„ memoizedState */
	if(enableCache) {
		const initialCache = createCache();
		retainCache(initialCache);
	
		root.pooledCache = initialCache;
		retainCache(initialCache);
		const initialState = {
			element: initialChildren,
			isDehydrated: hydrate,
			cache: initialCache
		};

		uninitializedFiber.memoizedState = initialState;
	} else {
		const initialState:RootState = {
			element: initialChildren,
			isDehydrated: hydrate,
			cache: (null: any)
		};
		uninitializedFiber.memoizedState = initialsTate;
	}

	/** åˆå§‹åŒ– HostRootFiber çš„æ›´ä¿®é˜Ÿåˆ— */
	initializeUpdateQueue(unitializedFiber);

	return root;
}
```               

è‡³æ­¤ï¼ŒFiberRoot å°±åˆ›å»ºå®Œæˆå•¦ï¼Œä¸‹é¢æˆ‘ä»¬å°†è®²è§£ HostRootFiber çš„åˆ›å»ºè¿‡ç¨‹ã€‚

#### 4.1.2 åˆ›å»º HostRootFiber 

ä¸Šé¢æåˆ°è¿‡ï¼ŒHostRootFiber å¯¹åº”ç€ Fiber æ¶æ„ä¸­æœªè¢«åˆå§‹åŒ–è¿‡çš„ Fiber æ ‘ï¼Œå®ƒè¢«æŒ‚è½½åˆ° FiberRoot çš„ current å±æ€§ä¸Šï¼Œå®ƒçš„ stateNode å±æ€§ä¹Ÿè¢«è®¾ç½®ä¸º FiberRoot ã€‚

createHostRootFiber æ˜¯ HostRootFiber çš„åˆ›å»ºå‡½æ•°ï¼Œä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š

 1. è®¾ç½® React Fiber æ¶æ„çš„å·¥ä½œæ¨¡å¼ ï¼ˆConcurrent æ¨¡å¼ã€ä¸¥æ ¼æ¨¡å¼ã€ConcurrentUpdatesByDefaultMode æ¨¡å¼ï¼‰
 2. è®¾ç½®æ€§èƒ½åˆ†æçš„æ¨¡å¼
 3. åˆ›å»º Fiber

```javascript
export function createHostRootFiber(
	tag,
	isStrictMode,
	concurrentUpdatesByDefaultOverride,
)  {
	let mode;

	/** Concurrent æ¨¡å¼  */
	if ( tag === ConcurrentRoot ) {
		mode = ConcurrentMode;

		/** ä¸¥æ ¼æ¨¡å¼ */
		if(isStrictMode === true || createRootStrictEffectsByDefault) {
			mode |= StrictLegacyMode | StrictEffectsMode;
		}

		if( 
			!enableSyncDefaultUpdates || 
			(allowConcurrentByDefault && concurrentUpdatesByDefaultOverride)
		) {
			/** è®¾ç½® ConcurrentUpdatesByDefaultMode  æ¨¡å¼ */
			mode |= ConcurrentUpdatesByDefaultMode;
		}
	/** é Concurrent æ¨¡å¼ */
	} else {
		mode = NoMode;
	}
     
    /** æ€§èƒ½åˆ†ææ¨¡å¼ */
	if(enableProfilerTimer && isDevToolsPresent) {
		mode |= ProfileMode;
	}

	return createFiber(HostRoot, null, null, mode);
}
```

ç»è¿‡ä»¥ä¸Šçš„æ­¥éª¤ï¼ŒFiberRoot å·²ç»è¢« React åˆ›å»ºå®Œæˆå•¦ï¼æœ€åæˆ‘ä»¬æ¥è®²è§£ä¸€ä¸‹ FiberRoot æ˜¯æ€ä¹ˆè¢«æŒ‚è½½åˆ° DOM å®¹å™¨èŠ‚ç‚¹ä¸Šçš„ã€‚

#### 4.1.3 FiberRoot çš„æŒ‚è½½ 

markContainerAsRoot æ˜¯è¿‡è½½ FiberRoot çš„å·¥ä½œå‡½æ•°ï¼Œå°† Dom å®¹å™¨èŠ‚ç‚¹çš„ \`\_reactFiber$${ramdomKey}\` å±æ€§è®¾ç½®ä¸º FiberRootã€‚

æºä»£ç å¦‚ä¸‹ï¼š

```javascript
cosnt randomKey = Math.ramdom().toString(36).slice(2);

const internalInstanceKey = '_reactFiber$' + randomKey;

/** åœ¨ DOM èŠ‚ç‚¹ä¸Šè®¾ç½®å±æ€§ '_reactFiber' + ramdomKey ä¸º FiberRoot */
export function markContainerAsRoot(hostInst, node) {
	node[internalInstanceKey] = hostInst;
} 
```               

## äº”ã€ç»“å°¾

è¿™äº›å°±æ˜¯ React çš„åˆå§‹åŒ–çš„å…¨è¿‡ç¨‹å•¦ï¼ æ¬¢è¿å°ä¼™ä¼´ä»¬ä¸€èµ·è®¨è®º~ @V@ ~

æœ€åæ¥åˆ™å¹¿å‘Š @v@~

> âœ¨ å¸ƒçµå¸ƒçµï¼YQY ä½ä»£ç å¹³å°é¦–å‘å•¦ï¼
> ---
> 
> #### ğŸ“ åŸºæœ¬åŠŸèƒ½
> 
> - é€šè¿‡æ‹–æ‹½è‡ªåŠ¨ç”Ÿæˆ React é¡¹ç›®ä»£ç ï¼ˆåŒ…å«è·¯ç”±ã€å¸ƒå±€ã€é¡µé¢ã€ç»„ä»¶ã€cssæ ·å¼ï¼‰ã€‚
> - è‡ªåŠ¨åŒ–ç”Ÿæˆä»£ç ä»“åº“ã€‚
> - è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - å¿«æ·è®¿é—®éƒ¨ç½²çš„é¡¹ç›®ã€é¡µé¢ã€‚
> - é€šè¿‡ä½ä»£ç å¹³å°å¯¹å·²ç”Ÿæˆçš„é¡¹ç›®è¿›è¡Œä¿®æ”¹ã€‚
> - æ‹‰å–é¡¹ç›®è‡³æœ¬åœ°ï¼Œç”±å¼€å‘äººå‘˜æ‰‹åŠ¨å¼€å‘ï¼Œæ¨é€åˆ°è¿œç¨‹ä»“åº“åè‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - æ¥å…¥ä¸åŒç»„ä»¶åº“ã€‚
> - æ”¯æŒæ¥å…¥åŸ‹ç‚¹ã€ç›‘æ§ç­‰å‰ç«¯æ¶æ„ã€‚
> 
> #### ğŸ“ ä¼˜ç‚¹
> 
> - ç”Ÿæˆçš„ä»£ç å¯è¯»æ€§å¥½ï¼ŒåŒ…å«æ³¨é‡Šã€‚
> - å¯ç”Ÿæˆä¸åŒç±»å‹çš„ç»„ä»¶ï¼ˆå‡½æ•°ç»„ä»¶ã€ç±»ç»„ä»¶ï¼‰ã€‚
> - å¯è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®ã€å¸ƒå±€ã€é¡µé¢ã€è·¯ç”±ç­‰ã€‚
> - æ”¯æŒè‡ªåŠ¨åˆ›å»ºä»£ç ä»“åº“ã€è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - æ”¯æŒæ¥å…¥ä¸åŒç»„ä»¶åº“ã€‚
> - æ”¯æŒæ¥å…¥åŸ‹ç‚¹ã€ç›‘æ§ç­‰ä¼ä¸šçº§å‰ç«¯æ¶æ„ã€‚
> 
> ğŸ˜ˆ å¦‚æ„Ÿå…´è¶£ï¼Œå¯è”ç³»æœ¬äººï¼šå¼ å¤§å¯çˆ±å®å® 
> 
> - tel: 16602927079 
> - email: zhangyueqingyun@foxmail.com
> - wechat: abcde-ovo-yz
> 
> ğŸ¼ å…¶ä»–
> ---
> 
> - ğŸ‹ [ä¸ªäººåšå®¢](https://zhangyueqingyun.tech)
> - ğŸ’ [ç®—æ³•æµ‹è¯•æ¡†æ¶](https://github.com/zhangyueqingyun/algorithm)
> - ğŸ“ [å‰ç«¯åŸåˆ›èµ„æº](https://github.com/zhangyueqingyun/blog-resources)
