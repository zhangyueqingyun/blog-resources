# FiberRoot çš„æŒ‚è½½

ğŸ˜† Hiï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¼ ç¥å¿äº‘ï¼Œä¸€ä¸ªé¢å‘æœªæ¥ç¼–ç¨‹çš„ç¨‹åºå‘˜ï¼å‡†å¤‡å°† React æºç è§£æå†™æˆä¸€ç³»åˆ—æ–‡ç« åˆ†äº«ç»™å¤§å®¶ï¼Œå¸Œæœ›å¤§å®¶å–œæ¬¢~ 

##  ä¸€ã€å‰è¨€

ä¸€ä¸ªæœ€ç®€å•çš„ React ç¨‹åºå¾€å¾€åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š

1. åˆ›å»º React å…ƒç´ æ ‘ï¼š

```javascript 
const element = React.createElement("div", {}, '');
```

2. åˆ›å»º FiberRoot èŠ‚ç‚¹å¹¶æŒ‚è½½åˆ° DOM å®¹å™¨èŠ‚ç‚¹ä¸Šï¼š

```javascript
const root = ReactDOM.createRoot(container);
```

3. FiberRoot æ¸²æŸ“ç¬¬ä¸€æ­¥åˆ›å»ºçš„ React å…ƒç´ æ ‘ï¼š

```javascript
root.render(element);
```

ä»Šå¤©æˆ‘ä»¬è¯¦ç»†è®²è§£çš„æ˜¯ FiberRoot çš„åˆ›å»ºå’ŒæŒ‚è½½ã€‚

## äºŒã€FiberRoot                                               

FiberRoot æ˜¯ React åº”ç”¨çš„æ€»æ§æ ¹èŠ‚ç‚¹ï¼ŒReact é€šè¿‡åˆ›å»º FiberRoot å¹¶å°†å…¶æŒ‚è½½åˆ° DOM å®¹å™¨å…ƒç´ ä¸Šæ¥åˆå§‹åŒ–å®ƒçš„å·¥ä½œç¯å¢ƒã€‚åˆ›å»º FbierRoot çš„ Api ä¸º React.createRootï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹ä¸€ä¸‹è¿™ä¸ª Apiã€‚

### 2.1 React.createRoot  

React.createRoot å‡½æ•°è´Ÿè´£åˆ›å»ºå’ŒæŒ‚è½½ FiberRoot ï¼Œå®ƒçš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. å¤„ç† options ä¸­ä¸€äº›å¯é…ç½®çš„å±æ€§
2. åˆ›å»º FiberRoot 
3. å°† FiberRoot æŒ‚è½½åˆ°äº† DOM å®¹å™¨èŠ‚ç‚¹ä¸Š
4. åˆå§‹åŒ– Dispatcher
5. è·å–å¹¶ç›‘å¬è¯¥ç›‘å¬çš„ DOM å®¹å™¨èŠ‚ç‚¹çš„æ‰€æœ‰äº‹ä»¶
6. è¿”å› ReactDOMRoot

```javascript
export function createRoot(
    container,
    options
) {
    if(!isValidContainer(container)) {
        throw new Error('createRoot(...): Target container is not a DOM element');
    }

    let isStrictMode = false;    // ä¸¥æ ¼æ¨¡å¼
    let concurrentUpdatesByDefaultOverride = false;    // è®¾ç½®æ›´æ–°æ¨¡å¼
    let identifierPrefix = '';    //  å‰ç¼€
    let onRecoverableError = defaultOnRecoverableError;  // å¯æ¢å¤çš„é”™è¯¯å¤„ç†æ–¹æ³•
    let transitionCallbacks = null;    // è¿‡åº¦å›è°ƒ

    if(options !== null && options !== undefined) {
        /** è®¾ç½®ä¸¥æ ¼æ¨¡å¼ */
        if(options.unstable_strictMode === true) {
            isStrictMode = true;
        }

        /** è®¾ç½® ConcurrentUpdatesByDefaultMode ä¸º true  */ 
        if(
            allowConcurrentByDefault &&
            options.unstable_concurrentUpdatesByDefault === true
        ) {
            concurrentUpdatesByDefaultOverride = true;
        }

        /** è®¾ç½®å‰ç¼€ */
        if(options.identifierPrefix !== undefined) {
            identifierPrefix = options..identifierPrefix;
        }

        /** è®¾ç½®å¯æ¢å¤çš„é”™è¯¯å¤„ç†å›è°ƒ */
        if(options.onRecoverableError !== undefined) {
            onRecoverableError = options.onRecoverableError;
        }

        /** è®¾ç½®è¿‡æ¸¡å›è°ƒ */
        if(options.unstable_transitionCallbacks !== undefined) {
            transitionCallbacks = options.unstable_transitionCallbacks;
        }
    }

    /** åˆ›å»º FiberRoot */
    const root = createContainer(
        container,
        ConcurrentRoot,
        null,
        isStrictMode,
        concurrentUpdatesByDefaultOverride,
        identifierPrefix,
        onRecoverableError,
        transitionCallbacks
    );

    /** å°† FiberRoot æŒ‚è½½åˆ° DOM èŠ‚ç‚¹ä¸Š */
    markContainerAsRoot(root.current, container);

    /** åˆå§‹åŒ– Dispatcher */
    if(enableFloat) {
        Dispatcher.current = ReactDOMClientDispatcher;
    }

    /** è·å–æ ¹å…ƒç´ èŠ‚ç‚¹ */
    const rootContainerElement = container.nodeType = COMMENT_NODE ? container.parentNode : container;

    /** ç›‘å¬æ ¹å…ƒç´ èŠ‚ç‚¹çš„æ‰€æœ‰äº‹ä»¶ */
    listenToAllSupportedEvents(rootContainerElement);

    /** è¿”å› ReactDOMRoot */
    return new ReactDOMRoot(root);
}
```

#### 2.1.1 FiberRoot çš„åˆ›å»º

ä¸Šé¢è®²äº†åˆ›å»ºæŒ‚è½½ FiberRoot çš„æ€»æ§å‡½æ•° React.createRoot ï¼Œç°åœ¨æˆ‘ä»¬è¯¦ç»†çœ‹ä¸€ä¸‹ FiberRoot çš„åˆ›å»ºã€‚

##### 2.1.1.1 FiberRootNode

æˆ‘ä»¬çœ‹ä¸€ä¸‹ FiberRoot çš„ç±»æ„é€ å‡½æ•° FiberRootNode ï¼Œå®ƒå®šä¹‰äº† FiberRoot æ‰€æ‹¥æœ‰çš„å±æ€§ï¼Œè¿™äº›å±æ€§è¯¦ç»†çš„æ„ä¹‰å°†åœ¨ Fiber æ¶æ„çš„æ‰§è¡Œæœºåˆ¶å½¼ç¯‡è®²è§£ï¼Œå¤§å®¶å…ˆç®€å•çœ‹ä¸€ä¸‹å®ƒçš„æºç ï¼š

```javascript
function FiberRootNode(
    containerInfo,
    tag,
    hydrate,
    identifierPrefix,
    onRecoverableError
) {
    this.tag = tag;
    this.containerInfo = containerInfo;    // DOM å®¹å™¨èŠ‚ç‚¹
    this.pendingChildren = null;    
    this.current = null;    // Fiber æ ‘
    this.pingCache = null;
    this.finishedWork = null;    
    this.timeoutHandle = noTimeout;
    this.context = null;
    this.pendingContext = null;
    this.callbackNode = null;
    this.callbackPriority = NoLane;
    this.eventTimes = createLaneMap(NoLanes);

    this.pendingLanes = NoLanes;
    this.suspencedLanes = NoLanes;
    this.pingedLanes = NoLanes;
    this.expiredLanes = NoLanes;
    this.mutableReadLanes = NoLanes;

    this.entangledLanes = NoLanes;
    this.hiddenUpdates = createLaneMap(null);

    this.identifierPrefix = identifierPrefix;
    this.onRecoverableError = onRecoverableError;

    if(enableCache) {
        this.pooledCache = null;
        this.pooledCacheLanes = NoLanes;
    }

    if(supportsHydration) {
        this.mutableSourceEagerHydrationData = null;
    }

    if(enableSuspenseCallback) {
        this.hydrationCallbacks = null;
    }

    this.incompleteTransitions = new Map();
    if(enableTransitionTracking) {
        this.transitionCallbacks = null;
        const transitionLanesMap = (this.transitionLanes = []);
        for(let i = 0; i < TotalLanes; i++) {
            pendingUpdatersLaneMap.push(new Set())
        }
    }
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹è´Ÿè´£åˆ›å»º FiberRoot çš„å‡½æ•° createContainer å’Œ createFiberRootã€‚

##### 2.1.1.2 createContainer

createContainer å‡½æ•°ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š

1. è®¾ç½® hydrate å’Œ initialChildren ä¸¤ä¸ªå±æ€§
2. è°ƒç”¨ createFiberRoot å‡½æ•°åˆ›å»º FiberRoot 

hydrate æ˜¯æœåŠ¡ç«¯æ¸²æŸ“æ³¨æ°´æ“ä½œçš„æ ‡å¿—ï¼Œè¢«è®¾ç½®ä¸º falseï¼ŒinitialChildren æ˜¯åˆå§‹åŒ–çš„å­èŠ‚ç‚¹ï¼Œè¢«è®¾ç½®ä¸º null ã€‚

```javascript
export function createContainer(
    containerInfo,
    tag,
    hydrationCallbacks,
    isStrictMode,
    concurrentUpdatesByDefaultOverride,
    identifierPrefix,
    onRecoverableError,
    transitionCallbacks
) {
    const hydrate = false;    // æœåŠ¡æ®µæ¸²æŸ“ç›¸å…³
    const initialChildren = null;    // åˆå§‹å­èŠ‚ç‚¹

    return createFiberRoot(
        containerInfo,
        tag,
        hydrate,
        initialChildren,
        hydrationCallbacks,
        isStrictMode,
        concurrentUpdatesByDefaultOverride,
        identifierPrefix,
        onRecoverableError,
        transitionCallbacks
    )
}
```          

##### 2.1.1.3 createFiberRoot

createFiberRoot åˆ›å»ºäº† FiberRoot å’Œ HostRootFiber ï¼ˆå°šæœªåˆå§‹åŒ–çš„ Fiber æ ‘ï¼‰, å¹¶åšäº†ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œå…·ä½“å¦‚ä¸‹ï¼š

1. åˆ›å»º FiberRoot
2. ä¸º FiberRoot è®¾ç½® hydrationCallbacks å’Œ transitionCallbacks
3. åˆ›å»º HostRootFiber
4. å°† FiberRoot.current è®¾ç½®ä¸º HostRootFiber
5. å°† HostRootFiber çš„ stateNode è®¾ç½®ä¸º FiberRoot
6. åˆå§‹åŒ– HostRootFiber çš„æ›´ä¿®é˜Ÿåˆ—

createFiberRoot å°† FiberRoot çš„ current å±æ€§è®¾ç½®ä¸º HostRootFiberï¼ŒåŒæ—¶ä¹Ÿå°† HostRootFiber çš„ stateNode å±æ€§è®¾ç½®ä¸º FiberRoot ï¼Œå®ƒä»¬æ‹¥æœ‰å½¼æ­¤çš„å¼•ç”¨ã€‚

``` javascript
export function createFiberRoot(
    containerInfo,
    tag,
    hydrate,
    initialChildren,
    hydrationCallbacks,
    isStrictMode,
    concurrentUpdatesByDefaultOverride,
    identifierPrefix,
    onRecoverableError,
    transitionCallbacks
) {
    /** åˆ›å»º FiberRoot */
    const root = new FiberRootNode(
        containerInfo,
        tag,
        hydrate,
        identifierPrefix,
        onRecoverableError
    );

    /** è®¾ç½®æœåŠ¡ç«¯æ¸²æŸ“å›è°ƒ */
    if(enableSuspenseCallback)  {
        root.hydrationCallbacks = hydrationCallbacks;
    }

    /** è®¾ç½®è¿‡æ¸¡å›è°ƒ */
    if(enableTransitionTracing) {
        root.transitionCallbacks = transitionCallbacks;
    }

    /** åˆ›å»º HostRootFiber */
    const uninitializedFiber = createHostRootFiber(
        tag,
        isStrictMode,
        concurrentUpdatesByDefaultOverride
    );

    /** å°† HostRootFiber æŒ‚è½½åˆ° FiberRoot çš„ current å±æ€§ä¸Š */
    root.current = uninitializedFiber;

    /** å°† HostRootFiber çš„ stateNode è®¾ç½®ä¸º FiberRoot */
    uninitializedFiber.stateNode = root;

    /** è®¾ç½® HostRootFiber çš„ memoizedState */
    if(enableCache) {
        const initialCache = createCache();
        retainCache(initialCache);
	
        root.pooledCache = initialCache;
        retainCache(initialCache);
        const initialState = {
            element: initialChildren,
            isDehydrated: hydrate,
            cache: initialCache
        };

        uninitializedFiber.memoizedState = initialState;
    } else {
        const initialState:RootState = {
            element: initialChildren,
            isDehydrated: hydrate,
            cache: (null: any)
        };
        uninitializedFiber.memoizedState = initialsTate;
    }

    /** åˆå§‹åŒ– HostRootFiber çš„æ›´ä¿®é˜Ÿåˆ— */
    initializeUpdateQueue(unitializedFiber);

    return root;
}
```               

è‡³æ­¤ï¼ŒFiberRoot å°±åˆ›å»ºå®Œæˆå•¦ï¼Œä¸‹é¢æˆ‘ä»¬å°†è®²è§£ HostRootFiber çš„åˆ›å»ºè¿‡ç¨‹ã€‚

#### 2.1.2 åˆ›å»º HostRootFiber 

ä¸Šé¢æåˆ°è¿‡ï¼ŒHostRootFiber å¯¹åº”ç€ Fiber æ¶æ„ä¸­æœªè¢«åˆå§‹åŒ–è¿‡çš„ Fiber æ ‘ï¼Œå®ƒè¢«æŒ‚è½½åˆ° FiberRoot çš„ current å±æ€§ä¸Šï¼Œå®ƒçš„ stateNode å±æ€§ä¹Ÿè¢«è®¾ç½®ä¸º FiberRoot ã€‚

createHostRootFiber æ˜¯ HostRootFiber çš„åˆ›å»ºå‡½æ•°ï¼Œä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š

 1. è®¾ç½® React Fiber æ¶æ„çš„å·¥ä½œæ¨¡å¼ ï¼ˆConcurrent æ¨¡å¼ã€ä¸¥æ ¼æ¨¡å¼ã€ConcurrentUpdatesByDefaultMode æ¨¡å¼ï¼‰ã€‚
 2. è®¾ç½®æ€§èƒ½åˆ†æçš„æ¨¡å¼ã€‚
 3. åˆ›å»º Fiberã€‚

```javascript
export function createHostRootFiber(
    tag,
    isStrictMode,
    concurrentUpdatesByDefaultOverride,
)  {
    let mode;

    /** Concurrent æ¨¡å¼  */
    if ( tag === ConcurrentRoot ) {
        mode = ConcurrentMode;

        /** ä¸¥æ ¼æ¨¡å¼ */
        if(isStrictMode === true || createRootStrictEffectsByDefault) {
            mode |= StrictLegacyMode | StrictEffectsMode;
        }

        if( 
            !enableSyncDefaultUpdates || 
            (allowConcurrentByDefault && concurrentUpdatesByDefaultOverride)
        ) {
            /** è®¾ç½® ConcurrentUpdatesByDefaultMode  æ¨¡å¼ */
            mode |= ConcurrentUpdatesByDefaultMode;
        }
	/** é Concurrent æ¨¡å¼ */
    } else {
        mode = NoMode;
    }
     
    /** æ€§èƒ½åˆ†ææ¨¡å¼ */
    if(enableProfilerTimer && isDevToolsPresent) {
        mode |= ProfileMode;
    }

    return createFiber(HostRoot, null, null, mode);
}
```

ç»è¿‡ä»¥ä¸Šçš„æ­¥éª¤ï¼ŒFiberRoot å·²ç»è¢« React åˆ›å»ºå®Œæˆå•¦ï¼æœ€åæˆ‘ä»¬æ¥è®²è§£ä¸€ä¸‹ FiberRoot æ˜¯æ€ä¹ˆè¢«æŒ‚è½½åˆ° DOM å®¹å™¨èŠ‚ç‚¹ä¸Šçš„ã€‚

#### 2.1.3 FiberRoot çš„æŒ‚è½½ 

markContainerAsRoot æ˜¯æŒ‚è½½ FiberRoot çš„å·¥ä½œå‡½æ•°ï¼Œå°† Dom å®¹å™¨èŠ‚ç‚¹çš„ \`\_reactFiber$${ramdomKey}\` å±æ€§è®¾ç½®ä¸º FiberRootã€‚

æºä»£ç å¦‚ä¸‹ï¼š

```javascript
cosnt randomKey = Math.ramdom().toString(36).slice(2);

const internalInstanceKey = '_reactFiber$' + randomKey;

/** åœ¨ DOM èŠ‚ç‚¹ä¸Šè®¾ç½®å±æ€§ '_reactFiber' + ramdomKey ä¸º FiberRoot */
export function markContainerAsRoot(hostInst, node) {
	node[internalInstanceKey] = hostInst;
} 
```               

## å››ã€ReactDOMRoot

æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ ReactDOM.createRoot çš„è¿”å›å€¼ ReactDOMRootã€‚

ReactDOMRoot æä¾›äº† render å’Œ unmount ä¸¤ä¸ªæ–¹æ³•ã€‚å®ƒå°† FiberRoot è®¾ç½®ä¸ºå…¶å†…éƒ¨å±æ€§ _internalRootï¼Œé€šè¿‡ FiberRoot å®Œæˆæ¸²æŸ“å’Œå¸è½½çš„å·¥ä½œï¼Œæºä»£ç å¦‚ä¸‹ï¼š 

```javascript
function ReactDOMRoot(internalRoot) {
    /** FiberRoot */
    this._internalRoot = internalRoot;
}

/** åˆ©ç”¨ FiberRoot æ¸²æŸ“ ReactElement */
ReactDOMRoot.prototype.render = function (children) {
    /** FiberRoot */
    const root = this._internalRoot;
    if(root === null) {
        throw new Error('Cannot update an unmounted root.');
    }
    
    /** æ¸²æŸ“ */
    updateContainer(children, root, null, null);
}

/** å¸è½½ FiberRoot */
ReactDOMRoot.prototype.unmount = function(): void {
    /** FiberRoot */
    const root = this._internalRoot;
    if (root !== null) {
        this._internalRoot = null;
        const container = root.containerInfo;

        /** æ¸…ç©º Fiber æ ‘ */
        flushSync(() => {
            updateContainer(null, root, null, null);
        });
        /** å°† FiberRoot ä» DOM å®¹å™¨å…ƒç´ ä¸Šå¸è½½ */
        unmarkContainerAsRoot(container);
    }
};
```

## ä¸‰ã€ç»“å°¾

è¿™äº›å°±æ˜¯ FiberRoot åˆ›å»ºåŠæŒ‚è½½çš„å…¨è¿‡ç¨‹å•¦ï¼ æ¬¢è¿å°ä¼™ä¼´ä»¬ä¸€èµ·è®¨è®º~ @V@ ~

æœ€åæ¥åˆ™å¹¿å‘Š @v@~

> âœ¨ å¸ƒçµå¸ƒçµï¼YQY ä½ä»£ç å¹³å°é¦–å‘å•¦ï¼
> ---
> 
> #### ğŸ“ åŸºæœ¬åŠŸèƒ½
> 
> - é€šè¿‡æ‹–æ‹½è‡ªåŠ¨ç”Ÿæˆ React é¡¹ç›®ä»£ç ï¼ˆåŒ…å«è·¯ç”±ã€å¸ƒå±€ã€é¡µé¢ã€ç»„ä»¶ã€cssæ ·å¼ï¼‰ã€‚
> - è‡ªåŠ¨åŒ–ç”Ÿæˆä»£ç ä»“åº“ã€‚
> - è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - å¿«æ·è®¿é—®éƒ¨ç½²çš„é¡¹ç›®ã€é¡µé¢ã€‚
> - é€šè¿‡ä½ä»£ç å¹³å°å¯¹å·²ç”Ÿæˆçš„é¡¹ç›®è¿›è¡Œä¿®æ”¹ã€‚
> - æ‹‰å–é¡¹ç›®è‡³æœ¬åœ°ï¼Œç”±å¼€å‘äººå‘˜æ‰‹åŠ¨å¼€å‘ï¼Œæ¨é€åˆ°è¿œç¨‹ä»“åº“åè‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - æ¥å…¥ä¸åŒç»„ä»¶åº“ã€‚
> - æ”¯æŒæ¥å…¥åŸ‹ç‚¹ã€ç›‘æ§ç­‰å‰ç«¯æ¶æ„ã€‚
> 
> #### ğŸ“ ä¼˜ç‚¹
> 
> - ç”Ÿæˆçš„ä»£ç å¯è¯»æ€§å¥½ï¼ŒåŒ…å«æ³¨é‡Šã€‚
> - å¯ç”Ÿæˆä¸åŒç±»å‹çš„ç»„ä»¶ï¼ˆå‡½æ•°ç»„ä»¶ã€ç±»ç»„ä»¶ï¼‰ã€‚
> - å¯è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®ã€å¸ƒå±€ã€é¡µé¢ã€è·¯ç”±ç­‰ã€‚
> - æ”¯æŒè‡ªåŠ¨åˆ›å»ºä»£ç ä»“åº“ã€è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚
> - æ”¯æŒæ¥å…¥ä¸åŒç»„ä»¶åº“ã€‚
> - æ”¯æŒæ¥å…¥åŸ‹ç‚¹ã€ç›‘æ§ç­‰ä¼ä¸šçº§å‰ç«¯æ¶æ„ã€‚
> 
> ğŸ˜ˆ å¦‚æ„Ÿå…´è¶£ï¼Œå¯è”ç³»æœ¬äººï¼šå¼ å¤§å¯çˆ±å®å® 
> 
> - tel: 16602927079 
> - email: zhangyueqingyun@foxmail.com
> - wechat: abcde-ovo-yz
> 
> ğŸ¼ å…¶ä»–
> ---
> 
> - ğŸ‹ [ä¸ªäººåšå®¢](https://zhangyueqingyun.tech)
> - ğŸ’ [ç®—æ³•æµ‹è¯•æ¡†æ¶](https://github.com/zhangyueqingyun/algorithm)
> - ğŸ“ [å‰ç«¯åŸåˆ›èµ„æº](https://github.com/zhangyueqingyun/blog-resources)
