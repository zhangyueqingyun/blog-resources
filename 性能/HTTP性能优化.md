# HTTP 中的性能优化
（来自 segmentdefault 佩奇烹饪家的博客 2022 前端性能优化实战）
## HTTP 1.1 
HTTP/1.1 中的大多数网站的性能优化技术都是减少向服务器发起的 HTTP 请求书。浏览器可以同时建立有限个 TCP 连接，而通过这些连接下载资源是一个线性的流程：一个资源的请求响应返回后，下一个请求才能发送，称为线头阻塞。

在 HTTP/1.1 中, Web 开发者往往将整个网站的 CSS 都合并到一个文件， Javascript 也被压缩到一个文件，图片被合并到了一张雪碧图上。合并 CSS、Javascript 和图片极大地减少了 HTTP 的请求数，在 HTTP/1.1 中能获得显著的性能提升。

### 存在的问题
为了尽可能减少请求数，需要做合并文件、雪碧图、资源内联等优化工作，这造成了单个文件变大延迟变高，且内嵌的资源不能有效地利用缓存。

## HTTP 2.0
### 二进制分帧传输
帧是数据传输的最小单位，以二进制传输代替原本的明文传输，原本的报文消息被划分为更小的数据帧

原来 Headers + Body 的报文格式如今被拆成了一个个的二进制帧，用 Headers 帧存放头部字段， Data 帧存放请求体字段。分帧后，服务器看到的不再是一个个完整的 HTTP 请求报文，而是一堆杂乱无章的二进制帧。这些二进制帧不存在先后关系，因此也就不会排队等待，也就没有了 HTTP 队头阻塞的问题。

### 多路复用
通信双方都可以给对方发送二进制帧，这种二进制帧的双徐昂传输的序列也叫做留。HTTP/2 用流在 TCP 连接上来进行多个数据帧的通信，这就是多路复用的概念。

在一个 tcp 连接上，我们可以对方不断地发送帧，每帧的 Stream Identifier 标明这一帧属于哪个流，然后再对方接收时，根据 Stream Identifier 拼接每个流的所有帧组成的一整块数据。把 HTTP/1.1 每个请求都当做一个流，多个请求变成多个流，请求响应数据分成多个帧，不同流中的帧交错地发送给对方，这就是 HTTP/2 的多路复用。

流的概念实现了单连接上多请求 - 响应并行，解决了线头阻塞的问题，减少了 TCP 连接数量和 TCP 连接慢启动造成的问题。所以 HTTP2 对于同一域名只需要创建一个连接。

### 服务端推送
在 HTTP/2 中，服务器已经不再是完全被动地接收请求，响应请求，它也能新建 stream 来给客户端发送消息。在 TCP 链接之后，比如浏览器请求一个 HTML 文件，服务器可以再返回 HTML 的基础上将 HTML 引用到的一些其他资源一起返回给客户端，减少等待。

Server-Push 主要是针对资源内联做出的优化，相较于 http/1.1 资源内联的优势

- 客户端可以缓存推送的资源
- 客户端可以拒收推送的资源
- 推送资源可以由不同页面共享
- 服务器可以按照优先级推送资源

### Header 压缩
使用 HPACK 算法压缩首部

## HTTP/2 Web 优化最佳实践
HTTP/2 的优化需要不同的思维方式。web 开发者应该专注于网站的缓存调优，而不是担心如何减少 http 请求数。法则为：传输轻量、细粒度的资源，以便独立缓存和并行传输。

### 停止合并文件
在 http/2 中合并文件不是最佳实践。虽然合并可以提高压缩率，但它使缓存失效。即使一行CSS改变，也会强制重新加载你所有的 CSS 声明。

另外，你的网站不是所有页面都是用了合并后的 CSS 或 JavaScript 文件中的全部声明或函数。被缓存之后到没什么关系，但这意味着在用户第一次访问时这些不必要的字节被传输、处理、执行。HTTP/1.1中请求的开销使得这种权衡是值得的。在 HTTP2中减慢了首屏绘制。

Web 开发者应该专注缓存策略优化而不是压缩文件。把经常改动和不改动的文件分离开，就可以尽可能利用 CDN 或者用户浏览器缓存中的内容。
### 停止内联资源
内敛资源是文件合并的一个特立，它指的是将 CSS 样式表、外部的 JavaScript 文件和图片直接嵌入到 HTML 页面中。
### 停止细分域名
细分域名是让浏览器建立更多 TCP 连接的通常手段。浏览器限制了单个服务器的连接数量，但是通过将网站的资源切分到几个域上，可以获得额外的 TCP 连接。它避免了线头阻塞，也带来了显著的代价。

细分域名在 HTTP/2 中应该避免。每个细分的域名都会带来额外的 DNS 查询、 TCP 连接 HE  TLS 握手。

## 一些通用最佳实践
### 减少 DNS 查询时间
在浏览器可以请求网站资源之前，它需要通过域名系统获得你的服务端的 IP 地址。知道 DNS 响应前，用户看到的都是白屏。 

- 使用 dns-prefetch 可提前获取DNS
- 减少主机名
- 使用 cdn 加速 dns 

### 静态资源使用 cdn 
内容分发网络（CDN）是一组分布在多个不同地理位置的 Web 服务器，我们都知道，当服务器离用户越远时，延迟越高。CDN 就是为了解决这个问题，在多个位置部署服务器，缩短请求时间。

### 利用浏览器缓存。
进一步利用内容分发网络，将资源存储在用户本地浏览器缓存中，除了产生一个 304 Not Modified 响应外，这避免了任何形式的数据在网络上传输。

### 最小化 HTTP 请求大小
尽管 HTTP/2 的请求使用了多路复用技术，但传输仍然需要时间。同时减少需要传输的数据规模同样会带来好处。在请求端，这意味着可以尽可能多地最小化 cookie, url 和查询字符串的大小。
### 最小化 HTTP 响应的大小
优化响应，并使用 gzip 压缩
### 减少不必要的重定向
## 代码压缩
### Node 
gzip 压缩
### Webpack 压缩
- javaScript UglifyPlugin
- CSS MiniCssExtractPlugin
- HTML htmlWebpackPlugin


