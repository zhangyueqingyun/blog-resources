# 订单系统

订单会存储关于产品、优惠、用户、支付信息等一系列的订单实时数据，来和下游系统，如促销、仓储、物流等进行交互。

随着平台业务的不断发展，品类丰富、交易方式丰富后，需要对订单进行多维度的分类管理，同时订单类型利于订单系统的扩展性。每种订单类型将会对应一套流程及一套状态，便于对订单进行分类管理和复用。

## 流程引擎在订单系统钟的应用

流程是指从平台角度触发，将订单从创建到完成整个的流转过程进行抽象，从而形成了一套标准流程规则。而不同的产品类型或交易类型在系统中的流程会千差万别，因此为了方便对订单流程进行管理，会组件流程引擎模块。

每套订单流程中会包含正向流程和逆向流程，正向流程可以比作一次顺利的网购体验过程，后台系统之间的信息流转。逆向流程则是修改订单、取消订单、退款、退货等各种动作引起的后台系统流程，同时每个流程触发的条件又可分为系统触发和人工触发两种场景。

### 订单流程

1. 订单创建

用户下单后，系统要生成订单，此时需要先获取下单中涉及的商品信息，然后获取该商品所涉及到的优惠信息，如果商品不参与优惠信息，则无此环节。

接着获取该账户的会员权益，这里要注意的是，优惠信息和会员权益的区别。比如：商品满减是优惠信息， SUPER 会员全场 9.9 折是会员权益，一个是针对商品，一个是针对账户。其次就是优惠活动的叠加规则和优先级规则。其次就是优惠活动的叠加规则和优先级规则。

增减库存规则是指订单中的商品，何时从仓储系统钟对相应商品库存进行扣除，目前主流有两种方式：

下单减库存 - 即用户下单成功时减少库存

## 状态机在订单系统中的应用

状态机是管理订单状态逻辑的工具。状态机可归纳为3个要素，即现态，动作，次态。

1. 现态：当前所处的状态。
2. 动作：执行完毕后，可以迁移到新的状态，也可以仍旧保持原状态。
3. 次态：动作满足后要迁往的新状态，"次态"是相对于“现态”而言的，“次态”一旦被激活，就转变成新的“现态了”。

订单系统为了高效的对订单进行跟踪和管理，会对订单流程当中的关键节点，抽象出订单状态。而订单状态从不同的角度可分为：系统订单状态，商家订单状态，买家订单状态等。

对于订单系统来说，订单状态细分的颗粒度越细，越明确，订单系统管理的精度和可靠性就越高，比如：在待付款和待发货两个状态中，订单系统后台会细分为订单超时取消、订单支付失败、订单付款完成等。

因此，订单状态模块中，通常会维护状态映射表，以不同的用户角色对系统订单状态进行重新划分，以满足不同用户的需求。

除此之外，随着电商平台的不断发展，不同的业务类型所对应的订单状态都会有所区别。所以，订单系统中一般会存储多套状态机，以满足不同的订单类型来使用。

## 订单中心

订单系统可拆分为订单中心与业务订单系统两个模块，管理公司所有的订单数据，为各个模块提供统一的服务。
